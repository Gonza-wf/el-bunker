<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El B√∫nker</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4?v=2"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js?v=2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
        
        * {
            font-family: 'Share Tech Mono', monospace;
        }
        
        .title-font {
            font-family: 'Orbitron', sans-serif;
        }
        
        .scanline {
            background: linear-gradient(
                transparent 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
        }
        
        .glow-red {
            box-shadow: 0 0 20px #ff0000, 0 0 40px #ff000066, inset 0 0 20px #ff000033;
        }
        
        .glow-green {
            box-shadow: 0 0 20px #00ff00, 0 0 40px #00ff0066, inset 0 0 20px #00ff0033;
        }
        
        .glow-blue {
            box-shadow: 0 0 15px #00aaff, 0 0 30px #00aaff66;
        }
        
        .glow-yellow {
            box-shadow: 0 0 20px #ffcc00, 0 0 40px #ffcc0066, inset 0 0 20px #ffcc0033;
        }
        
        .glow-cyan {
            box-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff66, inset 0 0 20px #00ffff33;
        }
        
        .spark {
            animation: spark 0.1s infinite;
        }
        
        @keyframes spark {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            41% { opacity: 1; }
            42% { opacity: 0.8; }
            43% { opacity: 1; }
            45% { opacity: 0.3; }
            46% { opacity: 1; }
        }
        
        .flicker {
            animation: flicker 3s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .wire {
            cursor: grab;
            transition: all 0.2s;
        }
        
        .wire:hover {
            filter: brightness(1.3);
        }
        
        .wire.dragging {
            cursor: grabbing;
            transform: scale(1.1);
        }
        
        .wire.locked {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }
        
        .terminal {
            transition: all 0.3s;
        }
        
        .terminal:hover {
            transform: scale(1.1);
        }
        
        .terminal.highlight {
            animation: pulse 0.5s infinite;
        }
        
        .terminal.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .connected {
            filter: brightness(1.5) saturate(1.2);
        }
        
        @keyframes doorOpen {
            0% { transform: scaleX(1); }
            100% { transform: scaleX(0); }
        }
        
        .door-open-left {
            animation: doorOpen 2s ease-in-out forwards;
            transform-origin: left;
        }
        
        .door-open-right {
            animation: doorOpen 2s ease-in-out forwards;
            transform-origin: right;
        }
        
        .manual-page {
            background: linear-gradient(135deg, #f4e4bc 0%, #e8d5a3 100%);
            box-shadow: 
                inset 0 0 30px rgba(139, 119, 42, 0.3),
                5px 5px 15px rgba(0,0,0,0.3);
            transition: filter 2s ease-out;
        }
        
        .manual-page.dimmed {
            filter: brightness(0.6);
        }
        
        .manual-page.very-dimmed {
            filter: brightness(0.3);
        }
        
        .stamp {
            transform: rotate(-15deg);
            opacity: 0.7;
        }
        
        .connection-line {
            stroke-dasharray: 5, 5;
            animation: dash 0.5s linear infinite;
        }
        
        @keyframes dash {
            to { stroke-dashoffset: -10; }
        }
        
        /* Coffee stain effect */
        .coffee-stain {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(ellipse at center, 
                rgba(101, 67, 33, 0.4) 0%, 
                rgba(139, 90, 43, 0.3) 30%,
                rgba(160, 120, 60, 0.2) 50%,
                transparent 70%);
            pointer-events: none;
        }
        
        /* Burn mark effect */
        .burn-mark {
            position: absolute;
            background: radial-gradient(ellipse at center,
                rgba(20, 10, 5, 0.9) 0%,
                rgba(40, 20, 10, 0.7) 30%,
                rgba(60, 30, 15, 0.4) 60%,
                transparent 80%);
            pointer-events: none;
            filter: blur(2px);
        }
        
        /* Error flash animation */
        @keyframes errorFlash {
            0%, 100% { background-color: transparent; }
            25%, 75% { background-color: rgba(255, 0, 0, 0.3); }
        }
        
        .error-flash {
            animation: errorFlash 0.5s ease-in-out;
        }
        
        /* Alert popup */
        @keyframes alertPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .alert-popup {
            animation: alertPulse 0.3s ease-in-out infinite;
        }
        
        /* Piston animation */
        @keyframes pistonMove {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-80px); }
        }
        
        .piston-animate {
            animation: pistonMove var(--piston-speed, 2s) ease-in-out infinite;
        }
        
        /* Oscilloscope wave */
        @keyframes waveMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        .wave-animate {
            animation: waveMove var(--wave-speed, 2s) linear infinite;
        }
        
        /* Charge button glow */
        @keyframes chargeGlow {
            0%, 100% { box-shadow: 0 0 10px #ff6600; }
            50% { box-shadow: 0 0 30px #ff6600, 0 0 60px #ff660066; }
        }
        
        .charge-ready {
            animation: chargeGlow 0.5s ease-in-out infinite;
        }
        
        /* Sync bar animation */
        @keyframes syncBarMove {
            0% { left: 0%; }
            100% { left: 100%; }
        }
        
        .sync-bar-animate {
            animation: syncBarMove var(--sync-duration, 1.5s) linear infinite;
        }
        
        /* Target zone pulse when bar is in zone */
        @keyframes targetPulse {
            0%, 100% { background-color: rgba(34, 197, 94, 0.2); }
            50% { background-color: rgba(34, 197, 94, 0.5); }
        }
        
        .target-active {
            animation: targetPulse 0.2s ease-in-out infinite;
        }
        
        /* Sync bar glow effect */
        .sync-bar-glow {
            box-shadow: 0 0 15px #00ffff, 0 0 30px #00ffff, 0 0 45px #00ffff;
        }
        
        /* Radio dial rotation */
        @keyframes dialSweep {
            0%, 100% { transform: rotate(-45deg); }
            50% { transform: rotate(45deg); }
        }
        
        /* Maze cell */
        .maze-cell {
            width: 40px;
            height: 40px;
            border: 1px solid #333;
            transition: all 0.2s;
        }
        
        .maze-cell.player {
            background: radial-gradient(circle, #00ff00 0%, #008800 100%);
            box-shadow: 0 0 10px #00ff00;
        }
        
        .maze-cell.wall {
            background: #333;
        }
        
        .maze-cell.exit {
            background: radial-gradient(circle, #ffcc00 0%, #ff8800 100%);
            box-shadow: 0 0 10px #ffcc00;
        }
        
        .maze-cell.mine {
            background: radial-gradient(circle, #ff0000 0%, #880000 100%);
        }
        
        /* Level transition */
        @keyframes levelTransition {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .level-enter {
            animation: levelTransition 0.5s ease-out forwards;
        }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .manual-page {
                padding: 1rem;
                transform: none !important;
                margin: 0.5rem;
            }
            
            .manual-page svg {
                max-height: 180px;
            }
            
            .maze-cell {
                width: 30px;
                height: 30px;
            }
        }
        
        /* Force overflow on body */
        body {
            overflow-y: auto !important;
        }
        
        /* Fullscreen button */
        .fs-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #555;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .fs-button:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: #888;
            transform: scale(1.1);
        }
        
        /* Success animations */
        @keyframes stabilize {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .stabilize-animation {
            animation: stabilize 1s ease-out forwards;
        }
        
        @keyframes greenPulse {
            0%, 100% { box-shadow: 0 0 50px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 100px rgba(34, 197, 94, 0.8); }
        }
        
        .green-pulse {
            animation: greenPulse 2s ease-in-out infinite;
        }
        
        /* Door closing animation */
        @keyframes doorClose {
            0% { transform: translateX(0); }
            100% { transform: translateX(0); }
        }
        
        .door-close-left {
            transform: translateX(0) !important;
        }
        
        .door-close-right {
            transform: translateX(0) !important;
        }
        
        /* Typing cursor effect */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .typing-cursor::after {
            content: '‚ñà';
            animation: blink 0.7s infinite;
            color: #22c55e;
        }
        
        /* Star rating animation */
        @keyframes starPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .star-animate {
            animation: starPop 0.3s ease-out forwards;
            opacity: 0;
        }
        
        /* Rank reveal animation */
        @keyframes rankReveal {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .rank-reveal {
            animation: rankReveal 0.5s ease-out forwards;
        }
        
        /* Terminal occupied indicator */
        .terminal.occupied::after {
            content: '‚úì';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #22c55e;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Level indicator */
        .level-badge {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #666;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen overflow-y-auto">
    <!-- Scanline overlay -->
    <div class="scanline fixed inset-0 z-30 pointer-events-none"></div>
    
    <!-- Emergency overlay -->
    <div id="emergency-overlay" class="fixed inset-0 bg-red-900 opacity-0 pointer-events-none z-25 transition-opacity duration-500"></div>
    
    <!-- Error flash overlay -->
    <div id="error-overlay" class="fixed inset-0 z-45 pointer-events-none"></div>
    
    <!-- Alert popup -->
    <div id="alert-popup" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-red-900 border-2 border-red-500 px-6 py-3 rounded-lg alert-popup">
        <div class="flex items-center gap-3">
            <span class="text-2xl">‚ö†Ô∏è</span>
            <div>
                <p class="text-red-300 font-bold" id="alert-title">¬°ALERTA!</p>
                <p class="text-red-400 text-sm" id="alert-message">Error detectado</p>
            </div>
        </div>
    </div>
    
    <!-- Level transition overlay -->
    <div id="level-transition" class="hidden fixed inset-0 z-60 bg-black flex items-center justify-center">
        <div class="text-center">
            <div class="text-6xl mb-4" id="level-icon">üîß</div>
            <h2 class="title-font text-4xl text-white mb-2" id="level-title">NIVEL 1</h2>
            <p class="text-gray-400" id="level-subtitle">El Panel El√©ctrico</p>
        </div>
    </div>
    
    <!-- LOBBY SCREEN -->
    <div id="lobby-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="text-center">
            <div class="mb-8">
                <h1 class="title-font text-6xl md:text-8xl font-black text-red-500 glow-red tracking-wider flicker">
                    EL B√öNKER
                </h1>
                <p class="text-gray-400 mt-4 text-lg tracking-widest">JUEGO COOPERATIVO ASIM√âTRICO</p>
                <p class="text-yellow-500 mt-2 text-sm">4 NIVELES DE ESCAPE</p>
            </div>
            
            <div class="bg-gray-800 border-2 border-gray-600 rounded-lg p-8 max-w-md mx-auto">
                <div class="space-y-6">
                    <div id="lobby-status" class="flex items-center justify-center gap-3 text-gray-400">
                        <div class="w-3 h-3 bg-green-500 rounded-full pulse"></div>
                        <span>SISTEMA OPERATIVO</span>
                    </div>
                    
                    <button id="create-btn" class="w-full bg-red-600 hover:bg-red-500 text-white py-4 px-8 rounded border-2 border-red-400 glow-red transition-all hover:scale-105 title-font text-xl tracking-wider">
                        ‚ö° CREAR PARTIDA
                    </button>
                    
                    <div id="link-section" class="hidden space-y-4">
                        <div class="bg-gray-900 p-4 rounded border border-gray-600">
                            <p class="text-gray-400 text-sm mb-2">ENLACE DE INVITACI√ìN:</p>
                            <div class="flex gap-2">
                                <input id="game-link" type="text" readonly class="flex-1 bg-gray-700 text-green-400 px-3 py-2 rounded text-sm border border-gray-600">
                                <button id="copy-btn" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-white transition-all">
                                    üìã
                                </button>
                            </div>
                        </div>
                        <div id="waiting-indicator" class="text-yellow-400 text-sm animate-pulse">
                            ‚è≥ Esperando a tu compa√±ero...
                        </div>
                    </div>
                    
                    <div id="join-section" class="hidden">
                        <div class="bg-green-900/30 border border-green-500 p-4 rounded">
                            <p class="text-green-400 mb-3">üîó Partida encontrada</p>
                            <button id="join-btn" class="w-full bg-green-600 hover:bg-green-500 text-white py-3 px-6 rounded border border-green-400 transition-all hover:scale-105 title-font">
                                UNIRSE COMO T√âCNICO
                            </button>
                        </div>
                    </div>
                    
                    <div id="connection-error" class="hidden bg-red-900/30 border border-red-500 p-4 rounded">
                        <p class="text-red-400">‚ùå Error de conexi√≥n. Intenta de nuevo.</p>
                    </div>
                </div>
            </div>
            
            <!-- Level preview -->
            <div class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 max-w-2xl mx-auto">
                <div class="bg-gray-800/50 p-3 rounded border border-gray-700">
                    <div class="text-2xl mb-1">üîå</div>
                    <p class="text-xs text-gray-400">Nivel 1</p>
                    <p class="text-yellow-400 text-sm">Panel El√©ctrico</p>
                </div>
                <div class="bg-gray-800/50 p-3 rounded border border-gray-700">
                    <div class="text-2xl mb-1">‚öõÔ∏è</div>
                    <p class="text-xs text-gray-400">Nivel 2</p>
                    <p class="text-orange-400 text-sm">El Reactor</p>
                </div>
                <div class="bg-gray-800/50 p-3 rounded border border-gray-700">
                    <div class="text-2xl mb-1">üìª</div>
                    <p class="text-xs text-gray-400">Nivel 3</p>
                    <p class="text-cyan-400 text-sm">Radio</p>
                </div>
                <div class="bg-gray-800/50 p-3 rounded border border-gray-700">
                    <div class="text-2xl mb-1">üó∫Ô∏è</div>
                    <p class="text-xs text-gray-400">Nivel 4</p>
                    <p class="text-purple-400 text-sm">Laberinto</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== PLAYER A SCREENS ==================== -->
    <div id="player-a-screen" class="hidden min-h-screen h-auto bg-gray-900 relative overflow-y-auto">
        <!-- Emergency glow -->
        <div id="emergency-glow" class="absolute inset-0 bg-red-900/20 opacity-0 pointer-events-none transition-opacity"></div>
        
        <!-- Background -->
        <div class="absolute inset-0 bg-gradient-to-b from-gray-800 to-gray-900">
            <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\"><rect fill=\"none\" stroke=\"%23666\" stroke-width=\"0.5\" width=\"100\" height=\"100\"/></svg>');"></div>
        </div>
        
        <!-- Header -->
        <div class="relative z-10 p-4 flex justify-between items-center border-b border-gray-700 bg-gray-800/80">
            <div class="flex items-center gap-4">
                <div class="w-3 h-3 bg-red-500 rounded-full spark"></div>
                <span class="text-red-400 title-font">OPERADOR</span>
                <span id="level-indicator-a" class="text-xs bg-yellow-700 px-2 py-1 rounded text-yellow-300">NIVEL 1</span>
            </div>
            <div class="flex items-center gap-4">
                <button id="sound-toggle-a" class="text-gray-400 hover:text-white transition-all" title="Sonido">üîä</button>
                <span id="connection-status-a" class="text-yellow-400">‚óè Conectando...</span>
            </div>
        </div>
        
        <!-- LEVEL 1: WIRES -->
        <div id="level-1-a" class="relative z-10 flex items-center justify-center min-h-[calc(100vh-80px)] p-4">
            <div id="main-panel-a" class="bg-gray-800 border-4 border-gray-600 rounded-lg p-8 max-w-2xl w-full shadow-2xl">
                <div class="text-center mb-6">
                    <h2 class="title-font text-2xl text-yellow-500">‚ö†Ô∏è PANEL EL√âCTRICO DA√ëADO</h2>
                    <p class="text-gray-400 text-sm mt-2">Conecta los cables correctamente para abrir la puerta</p>
                </div>
                
                <div id="sparks" class="absolute top-20 right-20 text-4xl spark">‚ö°</div>
                
                <!-- Lockdown display -->
                <div id="lockdown-display" class="hidden mb-6 bg-black rounded-lg p-4 border-4 border-red-600">
                    <div class="text-center">
                        <p class="text-red-500 text-xs mb-2 title-font">‚ö†Ô∏è SISTEMA BLOQUEADO</p>
                        <div id="lockdown-code" class="text-4xl title-font text-yellow-400 tracking-widest">----</div>
                        <p class="text-gray-500 text-xs mt-2">El t√©cnico debe ingresar el c√≥digo</p>
                    </div>
                </div>
                
                <!-- Wire area -->
                <div id="wire-area" class="relative bg-gray-900 rounded-lg p-6 border-2 border-gray-700">
                    <svg id="connection-svg" class="absolute inset-0 w-full h-full pointer-events-none z-10"></svg>
                    
                    <div class="flex justify-between items-center">
                        <div class="space-y-4">
                            <p class="text-gray-500 text-xs mb-4 text-center">CABLES</p>
                            <div id="wire-red" class="wire w-24 h-12 bg-gradient-to-r from-red-700 to-red-500 rounded-r-full border-2 border-red-400 flex items-center justify-end pr-3 cursor-pointer" data-color="red">
                                <div class="w-4 h-4 bg-red-300 rounded-full"></div>
                            </div>
                            <div id="wire-blue" class="wire w-24 h-12 bg-gradient-to-r from-blue-700 to-blue-500 rounded-r-full border-2 border-blue-400 flex items-center justify-end pr-3 cursor-pointer" data-color="blue">
                                <div class="w-4 h-4 bg-blue-300 rounded-full"></div>
                            </div>
                            <div id="wire-green" class="wire w-24 h-12 bg-gradient-to-r from-green-700 to-green-500 rounded-r-full border-2 border-green-400 flex items-center justify-end pr-3 cursor-pointer" data-color="green">
                                <div class="w-4 h-4 bg-green-300 rounded-full"></div>
                            </div>
                            <div id="wire-yellow" class="wire w-24 h-12 bg-gradient-to-r from-yellow-600 to-yellow-400 rounded-r-full border-2 border-yellow-400 flex items-center justify-end pr-3 cursor-pointer" data-color="yellow">
                                <div class="w-4 h-4 bg-yellow-200 rounded-full"></div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <p class="text-gray-500 text-xs mb-4 text-center">BORNES</p>
                            <div id="terminal-1" class="terminal w-16 h-12 bg-gray-700 rounded-l-lg border-2 border-gray-500 flex items-center justify-center text-white font-bold cursor-pointer hover:bg-gray-600 relative" data-terminal="1">1</div>
                            <div id="terminal-2" class="terminal w-16 h-12 bg-gray-700 rounded-l-lg border-2 border-gray-500 flex items-center justify-center text-white font-bold cursor-pointer hover:bg-gray-600 relative" data-terminal="2">2</div>
                            <div id="terminal-3" class="terminal w-16 h-12 bg-gray-700 rounded-l-lg border-2 border-gray-500 flex items-center justify-center text-white font-bold cursor-pointer hover:bg-gray-600 relative" data-terminal="3">3</div>
                            <div id="terminal-4" class="terminal w-16 h-12 bg-gray-700 rounded-l-lg border-2 border-gray-500 flex items-center justify-center text-white font-bold cursor-pointer hover:bg-gray-600 relative" data-terminal="4">4</div>
                        </div>
                    </div>
                </div>
                
                <div id="connections-display" class="mt-6 grid grid-cols-2 gap-2 text-sm">
                    <div class="bg-gray-900 p-2 rounded border border-gray-700 text-gray-500">
                        <span class="text-red-400">‚óè</span> Rojo ‚Üí <span id="red-conn">---</span>
                    </div>
                    <div class="bg-gray-900 p-2 rounded border border-gray-700 text-gray-500">
                        <span class="text-blue-400">‚óè</span> Azul ‚Üí <span id="blue-conn">---</span>
                    </div>
                    <div class="bg-gray-900 p-2 rounded border border-gray-700 text-gray-500">
                        <span class="text-green-400">‚óè</span> Verde ‚Üí <span id="green-conn">---</span>
                    </div>
                    <div class="bg-gray-900 p-2 rounded border border-gray-700 text-gray-500">
                        <span class="text-yellow-400">‚óè</span> Amarillo ‚Üí <span id="yellow-conn">---</span>
                    </div>
                </div>
                
                <div id="error-counter" class="mt-4 text-center text-gray-500 text-sm">
                    Errores: <span id="error-count">0</span>
                </div>
                
                <button id="reset-wires" class="mt-4 w-full bg-gray-700 hover:bg-gray-600 text-gray-300 py-2 rounded border border-gray-600 transition-all">
                    üîÑ Reiniciar conexiones
                </button>
            </div>
        </div>
        
        <!-- LEVEL 2: REACTOR -->
        <div id="level-2-a" class="hidden relative z-10 flex items-center justify-center min-h-[calc(100vh-80px)] p-4">
            <div class="bg-gray-800 border-4 border-orange-600 rounded-lg p-8 max-w-2xl w-full shadow-2xl glow-yellow">
                <div class="text-center mb-6">
                    <h2 class="title-font text-2xl text-orange-500">‚öõÔ∏è REACTOR DE FUSI√ìN</h2>
                    <p class="text-gray-400 text-sm mt-2">Presiona CARGA exactamente cuando el t√©cnico diga "¬°YA!"</p>
                    <p class="text-yellow-500 text-xs mt-1">‚ö° El t√©cnico ve la barra de sincronizaci√≥n - ¬°conf√≠a en √©l!</p>
                </div>
                
                <!-- Reactor visualization -->
                <div class="bg-gray-900 rounded-lg p-6 border-2 border-orange-700 mb-6">
                    <div class="relative h-48 flex items-end justify-center">
                        <!-- Reactor core -->
                        <div class="absolute bottom-0 w-32 h-8 bg-orange-900 rounded-t-lg"></div>
                        
                        <!-- Piston container -->
                        <div class="absolute bottom-8 w-24 h-32 bg-gray-700 rounded-t-lg border-2 border-gray-600 overflow-hidden">
                            <!-- Piston -->
                            <div id="reactor-piston" class="absolute bottom-0 w-full h-16 bg-gradient-to-t from-orange-600 to-yellow-500 piston-animate">
                                <div class="absolute top-2 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-white rounded-full"></div>
                            </div>
                        </div>
                        
                        <!-- Energy indicator -->
                        <div class="absolute top-0 right-4 text-center">
                            <p class="text-xs text-gray-500">ENERG√çA</p>
                            <div id="energy-bar" class="w-8 h-24 bg-gray-700 rounded border border-gray-600 mt-1 overflow-hidden">
                                <div id="energy-level" class="absolute bottom-0 w-full bg-gradient-to-t from-green-500 to-green-300 transition-all" style="height: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Cycle counter -->
                        <div class="absolute top-0 left-4 text-center">
                            <p class="text-xs text-gray-500">CICLOS</p>
                            <p id="cycle-count" class="text-2xl title-font text-orange-400">0/5</p>
                        </div>
                    </div>
                </div>
                
                <!-- Charge button -->
                <button id="charge-btn" class="w-full bg-orange-600 hover:bg-orange-500 text-white py-6 rounded-lg border-4 border-orange-400 title-font text-2xl transition-all active:scale-95">
                    ‚ö° CARGA ‚ö°
                </button>
                
                <!-- Timing feedback -->
                <div id="timing-feedback" class="mt-4 text-center text-gray-500">
                    Espera la se√±al del t√©cnico...
                </div>
                
                <!-- Overheat warning -->
                <div id="overheat-warning" class="hidden mt-4 bg-red-900/50 border-2 border-red-500 rounded-lg p-3">
                    <p class="text-red-400 text-center">üî• ¬°SOBRECALENTAMIENTO! Fallos: <span id="reactor-fails">0</span>/3</p>
                </div>
            </div>
        </div>
        
        <!-- LEVEL 3: RADIO -->
        <div id="level-3-a" class="hidden relative z-10 flex items-center justify-center min-h-[calc(100vh-80px)] p-4">
            <div class="bg-gray-800 border-4 border-cyan-600 rounded-lg p-8 max-w-2xl w-full shadow-2xl glow-cyan">
                <div class="text-center mb-6">
                    <h2 class="title-font text-2xl text-cyan-500">üìª FRECUENCIA DE EMERGENCIA</h2>
                    <p class="text-gray-400 text-sm mt-2">Escucha el c√≥digo y descr√≠belo al t√©cnico</p>
                </div>
                
                <!-- Radio display -->
                <div class="bg-gray-900 rounded-lg p-6 border-2 border-cyan-700 mb-6">
                    <!-- Frequency dial -->
                    <div class="flex justify-center mb-6">
                        <div class="relative w-48 h-48 bg-gray-800 rounded-full border-4 border-cyan-600">
                            <div class="absolute inset-4 bg-gray-900 rounded-full border-2 border-gray-700 flex items-center justify-center">
                                <div id="radio-dial" class="w-1 h-16 bg-cyan-400 origin-bottom transform -rotate-45"></div>
                            </div>
                            <!-- Frequency markers -->
                            <div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-xs text-gray-500">108</div>
                            <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-xs text-gray-500">88</div>
                            <div class="absolute left-2 top-1/2 transform -translate-y-1/2 text-xs text-gray-500">92</div>
                            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-xs text-gray-500">104</div>
                        </div>
                    </div>
                    
                    <!-- Current pattern display -->
                    <div class="bg-black rounded-lg p-4 mb-4">
                        <p class="text-xs text-gray-500 mb-2 text-center">PATR√ìN ACTUAL</p>
                        <div id="pattern-visual" class="flex justify-center gap-2 h-8">
                            <!-- Pattern dots will appear here -->
                        </div>
                    </div>
                    
                    <!-- Play button -->
                    <button id="play-pattern-btn" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white py-4 rounded border-2 border-cyan-400 title-font text-xl mb-4">
                        üîä REPRODUCIR SE√ëAL
                    </button>
                    
                    <!-- Switches -->
                    <div class="grid grid-cols-2 gap-4">
                        <button class="radio-switch bg-gray-700 hover:bg-gray-600 text-white py-3 rounded border border-gray-600" data-switch="oxygen">
                            üí® OX√çGENO
                        </button>
                        <button class="radio-switch bg-gray-700 hover:bg-gray-600 text-white py-3 rounded border border-gray-600" data-switch="door">
                            üö™ PUERTA
                        </button>
                        <button class="radio-switch bg-gray-700 hover:bg-gray-600 text-white py-3 rounded border border-gray-600" data-switch="power">
                            ‚ö° ENERG√çA
                        </button>
                        <button class="radio-switch bg-gray-700 hover:bg-gray-600 text-white py-3 rounded border border-gray-600" data-switch="vent">
                            üåÄ VENTILACI√ìN
                        </button>
                    </div>
                </div>
                
                <!-- Progress -->
                <div class="text-center text-gray-400">
                    Se√±ales decodificadas: <span id="signals-decoded">0</span>/4
                </div>
            </div>
        </div>
        
        <!-- LEVEL 4: MAZE -->
        <div id="level-4-a" class="hidden relative z-10 flex items-center justify-center min-h-[calc(100vh-80px)] p-4">
            <div class="bg-gray-800 border-4 border-purple-600 rounded-lg p-8 max-w-2xl w-full shadow-2xl">
                <div class="text-center mb-6">
                    <h2 class="title-font text-2xl text-purple-500">üó∫Ô∏è T√öNEL DE ESCAPE</h2>
                    <p class="text-gray-400 text-sm mt-2">El t√©cnico ve el mapa. T√∫ solo ves tu posici√≥n.</p>
                </div>
                
                <!-- Maze grid (player view - no walls) -->
                <div class="bg-gray-900 rounded-lg p-4 border-2 border-purple-700 mb-6">
                    <div id="maze-player-view" class="grid gap-1 justify-center" style="grid-template-columns: repeat(7, 40px);">
                        <!-- Maze cells will be generated by JS -->
                    </div>
                </div>
                
                <!-- Movement controls -->
                <div class="grid grid-cols-3 gap-2 max-w-48 mx-auto">
                    <div></div>
                    <button class="maze-move bg-purple-600 hover:bg-purple-500 text-white py-4 rounded text-2xl" data-dir="up">‚Üë</button>
                    <div></div>
                    <button class="maze-move bg-purple-600 hover:bg-purple-500 text-white py-4 rounded text-2xl" data-dir="left">‚Üê</button>
                    <button class="maze-move bg-gray-700 text-gray-400 py-4 rounded text-xl">‚óè</button>
                    <button class="maze-move bg-purple-600 hover:bg-purple-500 text-white py-4 rounded text-2xl" data-dir="right">‚Üí</button>
                    <div></div>
                    <button class="maze-move bg-purple-600 hover:bg-purple-500 text-white py-4 rounded text-2xl" data-dir="down">‚Üì</button>
                    <div></div>
                </div>
                
                <!-- Position display -->
                <div class="mt-4 text-center text-gray-500">
                    Posici√≥n: <span id="player-pos" class="text-purple-400">(1, 1)</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== PLAYER B SCREENS ==================== -->
    <div id="player-b-screen" class="hidden min-h-screen h-auto bg-amber-900 relative overflow-y-auto pb-8">
        <div class="absolute inset-0 bg-gradient-to-br from-amber-800 to-amber-950"></div>
        
        <!-- Header -->
        <div class="relative z-10 p-4 flex justify-between items-center border-b border-amber-700 bg-amber-800/80">
            <div class="flex items-center gap-4">
                <div class="w-3 h-3 bg-green-500 rounded-full pulse"></div>
                <span class="text-amber-200 title-font">T√âCNICO</span>
                <span id="level-indicator-b" class="text-xs bg-yellow-700 px-2 py-1 rounded text-yellow-300">NIVEL 1</span>
            </div>
            <div class="flex items-center gap-4">
                <button id="sound-toggle-b" class="text-amber-300 hover:text-white transition-all" title="Sonido">üîä</button>
                <span id="connection-status-b" class="text-yellow-400">‚óè Conectando...</span>
            </div>
        </div>
        
        <!-- LEVEL 1: MANUAL -->
        <div id="level-1-b" class="relative z-10 p-8 flex justify-center">
            <div id="manual-page" class="manual-page rounded-lg p-8 max-w-2xl w-full transform rotate-1 relative">
                <!-- Coffee stains -->
                <div class="coffee-stain" style="width: 120px; height: 100px; top: 60px; right: 80px;"></div>
                <div class="coffee-stain" style="width: 80px; height: 70px; bottom: 200px; left: 40px;"></div>
                
                <div class="stamp absolute top-4 right-4 border-4 border-red-700 text-red-700 px-4 py-2 font-bold text-xl rounded z-20">
                    CONFIDENCIAL
                </div>
                
                <div class="text-center mb-8 border-b-2 border-amber-700 pb-4 relative z-10">
                    <h2 class="title-font text-3xl text-gray-800">üìã MANUAL T√âCNICO</h2>
                    <p class="text-gray-600 mt-2">Sistema El√©ctrico - Secci√≥n 7B</p>
                </div>
                
                <!-- Diagram -->
                <div class="bg-white/50 rounded-lg p-6 mb-6 border-2 border-amber-600 relative z-10">
                    <h3 class="text-gray-800 font-bold mb-4 text-center">DIAGRAMA DE CONEXIONES</h3>
                    
                    <svg viewBox="0 0 400 250" class="w-full max-w-md mx-auto">
                        <defs>
                            <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                                <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#ddd" stroke-width="0.5"/>
                            </pattern>
                        </defs>
                        <rect width="400" height="250" fill="url(#grid)"/>
                        
                        <rect x="20" y="100" width="60" height="50" fill="#333" stroke="#000" stroke-width="2"/>
                        <text x="50" y="130" text-anchor="middle" fill="white" font-size="12">FUENTE</text>
                        
                        <line x1="80" y1="105" x2="150" y2="40" stroke="red" stroke-width="4"/>
                        <line x1="80" y1="115" x2="150" y2="90" stroke="blue" stroke-width="4"/>
                        <line x1="80" y1="135" x2="150" y2="160" stroke="green" stroke-width="4"/>
                        <line x1="80" y1="145" x2="150" y2="210" stroke="yellow" stroke-width="4"/>
                        
                        <circle cx="150" cy="40" r="10" fill="red" stroke="#800" stroke-width="2"/>
                        <circle cx="150" cy="90" r="10" fill="blue" stroke="#008" stroke-width="2"/>
                        <circle cx="150" cy="160" r="10" fill="green" stroke="#080" stroke-width="2"/>
                        <circle cx="150" cy="210" r="10" fill="yellow" stroke="#880" stroke-width="2"/>
                        
                        <path d="M 165 40 L 250 40" stroke="#333" stroke-width="2"/>
                        <path d="M 165 90 L 250 160" stroke="#333" stroke-width="2"/>
                        <path d="M 165 160 L 250 90" stroke="#333" stroke-width="2"/>
                        <path d="M 165 210 L 250 210" stroke="#333" stroke-width="2"/>
                        
                        <rect x="250" y="25" width="50" height="30" fill="#555" stroke="#333" stroke-width="2" rx="5"/>
                        <text x="275" y="45" text-anchor="middle" fill="white" font-weight="bold">1</text>
                        
                        <rect x="250" y="75" width="50" height="30" fill="#555" stroke="#333" stroke-width="2" rx="5"/>
                        <text x="275" y="95" text-anchor="middle" fill="white" font-weight="bold">2</text>
                        
                        <rect x="250" y="145" width="50" height="30" fill="#555" stroke="#333" stroke-width="2" rx="5"/>
                        <text x="275" y="165" text-anchor="middle" fill="white" font-weight="bold">3</text>
                        
                        <rect x="250" y="195" width="50" height="30" fill="#555" stroke="#333" stroke-width="2" rx="5"/>
                        <text x="275" y="215" text-anchor="middle" fill="white" font-weight="bold">4</text>
                    </svg>
                </div>
                
                <!-- Instructions -->
                <div class="bg-amber-100 rounded-lg p-4 border-2 border-amber-400 mb-6 relative z-10">
                    <h3 class="text-gray-800 font-bold mb-3">üìù INSTRUCCIONES:</h3>
                    <ul class="text-gray-700 space-y-2 text-sm">
                        <li>‚Ä¢ <span class="font-bold text-red-600">ROJO</span> ‚Üí borne <span class="font-bold">1</span></li>
                        <li>‚Ä¢ <span class="font-bold text-blue-600">AZUL</span> ‚Üí borne <span class="font-bold">3</span></li>
                        <li>‚Ä¢ <span class="font-bold text-green-600">VERDE</span> ‚Üí borne <span class="font-bold">2</span></li>
                        <li>‚Ä¢ <span class="font-bold text-yellow-600">AMARILLO</span> ‚Üí borne <span class="font-bold">4</span></li>
                    </ul>
                </div>
                
                <!-- Keypad -->
                <div id="security-keypad-container" class="hidden mt-6 relative z-10">
                    <div id="security-keypad" class="bg-gray-900 rounded-lg p-4 border-2 border-red-500">
                        <p class="text-red-500 text-xs mb-3 text-center title-font">üîí PROTOCOLO DE REINICIO</p>
                        
                        <div id="keypad-display" class="w-full bg-black text-green-500 text-center font-bold text-2xl py-3 rounded mb-3 title-font tracking-widest border border-green-900">
                            ----
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2">
                            <button class="keypad-btn bg-gray-700 hover:bg-gray-600 text-white py-3 rounded font-bold text-xl" data-num="1">1</button>
                            <button class="keypad-btn bg-gray-700 hover:bg-gray-600 text-white py-3 rounded font-bold text-xl" data-num="2">2</button>
                            <button class="keypad-btn bg-gray-700 hover:bg-gray-600 text-white py-3 rounded font-bold text-xl" data-num="3">3</button>
                            <button class="keypad-btn bg-gray-700 hover:bg-gray-600 text-white py-3 rounded font-bold text-xl" data-num="4">4</button>
                            <button class="keypad-btn bg-gray-700 hover:bg-gray-600 text-white py-3 rounded font-bold text-xl" data-num="5">5</button>
                            <button class="keypad-btn bg-gray-700 hover:bg-gray-600 text-white py-3 rounded font-bold text-xl" data-num="6">6</button>
                            <button class="keypad-btn bg-gray-700 hover:bg-gray-600 text-white py-3 rounded font-bold text-xl" data-num="7">7</button>
                            <button class="keypad-btn bg-gray-700 hover:bg-gray-600 text-white py-3 rounded font-bold text-xl" data-num="8">8</button>
                            <button class="keypad-btn bg-gray-700 hover:bg-gray-600 text-white py-3 rounded font-bold text-xl" data-num="9">9</button>
                            <button class="keypad-btn bg-red-700 hover:bg-red-600 text-white py-3 rounded font-bold text-xl" data-num="clear">‚úï</button>
                            <button class="keypad-btn bg-gray-700 hover:bg-gray-600 text-white py-3 rounded font-bold text-xl" data-num="0">0</button>
                            <button class="keypad-btn bg-green-700 hover:bg-green-600 text-white py-3 rounded font-bold text-xl" data-num="enter">‚úì</button>
                        </div>
                    </div>
                </div>
                
                <!-- Live status -->
                <div class="mt-6 bg-gray-800 rounded-lg p-4 border-2 border-gray-600 relative z-10">
                    <h3 class="text-green-400 font-bold mb-3">üì° ESTADO EN TIEMPO REAL:</h3>
                    <div id="live-status" class="grid grid-cols-2 gap-2 text-sm">
                        <div class="bg-gray-900 p-2 rounded text-gray-400">
                            <span class="text-red-400">‚óè</span> Rojo ‚Üí <span id="live-red">---</span>
                        </div>
                        <div class="bg-gray-900 p-2 rounded text-gray-400">
                            <span class="text-blue-400">‚óè</span> Azul ‚Üí <span id="live-blue">---</span>
                        </div>
                        <div class="bg-gray-900 p-2 rounded text-gray-400">
                            <span class="text-green-400">‚óè</span> Verde ‚Üí <span id="live-green">---</span>
                        </div>
                        <div class="bg-gray-900 p-2 rounded text-gray-400">
                            <span class="text-yellow-400">‚óè</span> Amarillo ‚Üí <span id="live-yellow">---</span>
                        </div>
                    </div>
                    <div class="mt-3 text-center text-gray-400">
                        Correctas: <span id="correct-count">0</span>/4
                    </div>
                </div>
            </div>
        </div>
        
        <!-- LEVEL 2: OSCILLOSCOPE -->
        <div id="level-2-b" class="hidden relative z-10 p-8 flex justify-center">
            <div class="manual-page rounded-lg p-8 max-w-2xl w-full relative">
                <div class="text-center mb-6 border-b-2 border-amber-700 pb-4">
                    <h2 class="title-font text-3xl text-gray-800">üìä MONITOR DE REACTOR</h2>
                    <p class="text-gray-600 mt-2">Gu√≠a de Sincronizaci√≥n</p>
                </div>
                
                <!-- Oscilloscope with Sync Bar -->
                <div class="bg-gray-900 rounded-lg p-4 border-2 border-orange-600 mb-6">
                    <p class="text-orange-400 text-xs mb-2 text-center">OSCILOSCOPIO - BARRA DE SINCRONIZACI√ìN</p>
                    
                    <!-- Sync Bar Display -->
                    <div class="relative h-20 bg-black rounded overflow-hidden mb-4 border-2 border-gray-700">
                        <!-- Grid lines -->
                        <div class="absolute inset-0 flex">
                            <div class="flex-1 border-r border-gray-800"></div>
                            <div class="flex-1 border-r border-gray-800"></div>
                            <div class="flex-1 border-r border-yellow-600 border-2"></div>
                            <div class="flex-1 border-r border-gray-800"></div>
                            <div class="flex-1"></div>
                        </div>
                        
                        <!-- Target zone (center) -->
                        <div class="absolute top-0 bottom-0 left-[40%] w-[20%] bg-green-500/20 border-x-2 border-green-500">
                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-green-400 text-xs font-bold">
                                ¬°YA!
                            </div>
                        </div>
                        
                        <!-- Moving sync bar -->
                        <div id="sync-bar" class="absolute top-0 bottom-0 w-1 bg-cyan-400 shadow-lg transition-none" style="left: 0%; box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff;">
                            <div class="absolute -top-1 left-1/2 transform -translate-x-1/2 text-cyan-400 text-lg">‚ñº</div>
                            <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 text-cyan-400 text-lg">‚ñ≤</div>
                        </div>
                    </div>
                    
                    <!-- Wave visualization -->
                    <div class="relative h-24 bg-black rounded overflow-hidden">
                        <!-- Grid -->
                        <div class="absolute inset-0 opacity-30" style="background-image: url('data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;40&quot; height=&quot;40&quot;><rect fill=&quot;none&quot; stroke=&quot;%23333&quot; stroke-width=&quot;0.5&quot; width=&quot;40&quot; height=&quot;40&quot;/></svg>');"></div>
                        
                        <!-- Wave -->
                        <svg id="oscilloscope-wave" class="absolute inset-0 w-[200%] h-full wave-animate" viewBox="0 0 800 100" preserveAspectRatio="none">
                            <path d="M 0 50 Q 50 0, 100 50 Q 150 100, 200 50 Q 250 0, 300 50 Q 350 100, 400 50 Q 450 0, 500 50 Q 550 100, 600 50 Q 650 0, 700 50 Q 750 100, 800 50" 
                                  fill="none" stroke="#00ff00" stroke-width="3"/>
                        </svg>
                        
                        <!-- Peak indicator -->
                        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 text-xs text-green-400">‚ñº PICO</div>
                    </div>
                    
                    <!-- Timing display -->
                    <div class="mt-4 text-center">
                        <p class="text-gray-500 text-xs">CICLO DE SINCRONIZACI√ìN</p>
                        <p id="peak-interval" class="text-4xl title-font text-orange-400">1.5s</p>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="bg-amber-100 rounded-lg p-4 border-2 border-amber-400 mb-6">
                    <h3 class="text-gray-800 font-bold mb-3">üìù INSTRUCCIONES:</h3>
                    <ol class="text-gray-700 space-y-2 text-sm list-decimal list-inside">
                        <li>Observa la <span class="font-bold text-cyan-600">barra azul</span> movi√©ndose</li>
                        <li>Cuando la barra entre en la <span class="font-bold text-green-600">zona verde</span>, grita "¬°YA!"</li>
                        <li>El operador debe presionar CARGA inmediatamente</li>
                        <li>Completa <span class="font-bold">5 ciclos</span> exitosos (m√°x 3 fallos)</li>
                    </ol>
                    <p class="mt-3 text-xs text-gray-600 italic">üí° Tienes ~250ms de margen. Cuanto m√°s preciso, mejor.</p>
                </div>
                
                <!-- Countdown helper -->
                <div class="bg-gray-800 rounded-lg p-6 border-2 border-orange-600">
                    <p class="text-center text-orange-400 mb-4 title-font">üéØ INDICADOR DE SINCRONIZACI√ìN</p>
                    <div id="rhythm-counter" class="text-center text-6xl title-font text-orange-400 h-20 flex items-center justify-center">
                        ‚óè
                    </div>
                    <p class="text-center text-gray-400 text-sm mt-4">Grita "¬°YA!" cuando la barra entre en la zona verde</p>
                    <div class="mt-4 bg-black/50 rounded p-3">
                        <p class="text-xs text-gray-500 text-center">Pr√≥ximo pico en:</p>
                        <p id="peak-countdown" class="text-2xl title-font text-center text-orange-400">--</p>
                    </div>
                </div>
                
                <!-- Cycle progress for tech -->
                <div class="mt-4 bg-gray-800 rounded-lg p-4 border-2 border-gray-600">
                    <div class="flex justify-between items-center">
                        <div class="text-center flex-1">
                            <p class="text-xs text-gray-500">CICLOS</p>
                            <p id="tech-cycles" class="text-2xl title-font text-green-400">0/5</p>
                        </div>
                        <div class="w-px h-12 bg-gray-600"></div>
                        <div class="text-center flex-1">
                            <p class="text-xs text-gray-500">FALLOS</p>
                            <p id="tech-fails" class="text-2xl title-font text-red-400">0/3</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- LEVEL 3: RADIO MANUAL -->
        <div id="level-3-b" class="hidden relative z-10 p-8 flex justify-center">
            <div class="manual-page rounded-lg p-8 max-w-2xl w-full relative">
                <div class="text-center mb-6 border-b-2 border-amber-700 pb-4">
                    <h2 class="title-font text-3xl text-gray-800">üìª C√ìDIGOS DE RADIO</h2>
                    <p class="text-gray-600 mt-2">Tabla de Traducci√≥n Morse</p>
                </div>
                
                <!-- Code table -->
                <div class="bg-white/80 rounded-lg p-4 border-2 border-cyan-600 mb-6">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b-2 border-gray-400">
                                <th class="py-2 text-left">PATR√ìN</th>
                                <th class="py-2 text-left">SISTEMA</th>
                                <th class="py-2 text-left">INTERRUPTOR</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700">
                            <tr class="border-b border-gray-300">
                                <td class="py-3 font-mono">‚óè ‚óè ‚óè</td>
                                <td>Tres cortos</td>
                                <td class="font-bold text-cyan-600">üí® OX√çGENO</td>
                            </tr>
                            <tr class="border-b border-gray-300">
                                <td class="py-3 font-mono">‚ñ¨</td>
                                <td>Un largo</td>
                                <td class="font-bold text-cyan-600">üö™ PUERTA</td>
                            </tr>
                            <tr class="border-b border-gray-300">
                                <td class="py-3 font-mono">‚óè ‚ñ¨ ‚óè</td>
                                <td>Corto-largo-corto</td>
                                <td class="font-bold text-cyan-600">‚ö° ENERG√çA</td>
                            </tr>
                            <tr>
                                <td class="py-3 font-mono">‚ñ¨ ‚ñ¨</td>
                                <td>Dos largos</td>
                                <td class="font-bold text-cyan-600">üåÄ VENTILACI√ìN</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Tips -->
                <div class="bg-amber-100 rounded-lg p-4 border-2 border-amber-400 mb-6">
                    <h3 class="text-gray-800 font-bold mb-2">üí° CONSEJOS:</h3>
                    <ul class="text-gray-700 text-sm space-y-1">
                        <li>‚Ä¢ "Corto" = pitido breve (‚óè)</li>
                        <li>‚Ä¢ "Largo" = pitido extendido (‚ñ¨)</li>
                        <li>‚Ä¢ Pide al operador que reproduzca la se√±al varias veces</li>
                    </ul>
                </div>
                
                <!-- Current signal status -->
                <div class="bg-gray-800 rounded-lg p-4 border-2 border-gray-600">
                    <h3 class="text-cyan-400 font-bold mb-3">üì° SE√ëALES RECIBIDAS:</h3>
                    <div id="signals-status" class="space-y-2 text-sm">
                        <div class="flex justify-between text-gray-400">
                            <span>üí® Ox√≠geno</span>
                            <span id="signal-oxygen" class="text-red-400">‚è≥ Pendiente</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>üö™ Puerta</span>
                            <span id="signal-door" class="text-red-400">‚è≥ Pendiente</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>‚ö° Energ√≠a</span>
                            <span id="signal-power" class="text-red-400">‚è≥ Pendiente</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>üåÄ Ventilaci√≥n</span>
                            <span id="signal-vent" class="text-red-400">‚è≥ Pendiente</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- LEVEL 4: MAZE MAP -->
        <div id="level-4-b" class="hidden relative z-10 p-8 flex justify-center">
            <div class="manual-page rounded-lg p-8 max-w-2xl w-full relative">
                <div class="text-center mb-6 border-b-2 border-amber-700 pb-4">
                    <h2 class="title-font text-3xl text-gray-800">üó∫Ô∏è MAPA DEL T√öNEL</h2>
                    <p class="text-gray-600 mt-2">Gu√≠a al operador hacia la salida</p>
                </div>
                
                <!-- Maze map (technician view - with walls) -->
                <div class="bg-gray-900 rounded-lg p-4 border-2 border-purple-600 mb-6">
                    <div id="maze-tech-view" class="grid gap-1 justify-center" style="grid-template-columns: repeat(7, 40px);">
                        <!-- Maze cells will be generated by JS -->
                    </div>
                    
                    <!-- Legend -->
                    <div class="mt-4 flex justify-center gap-4 text-xs">
                        <div class="flex items-center gap-1">
                            <div class="w-4 h-4 bg-gray-700 border border-gray-600"></div>
                            <span class="text-gray-400">Muro</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-4 h-4 bg-red-600 rounded-full"></div>
                            <span class="text-gray-400">Mina</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-4 h-4 bg-yellow-500 rounded-full"></div>
                            <span class="text-gray-400">Salida</span>
                        </div>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="bg-amber-100 rounded-lg p-4 border-2 border-amber-400 mb-6">
                    <h3 class="text-gray-800 font-bold mb-2">üìù INSTRUCCIONES:</h3>
                    <ul class="text-gray-700 text-sm space-y-1">
                        <li>‚Ä¢ T√∫ ves el mapa completo, el operador NO</li>
                        <li>‚Ä¢ Gu√≠ale: "Sube 2, derecha 1, baja 3..."</li>
                        <li>‚Ä¢ Si toca un muro = error</li>
                        <li>‚Ä¢ Si toca una mina = ¬°BOOM!</li>
                    </ul>
                </div>
                
                <!-- Position tracker -->
                <div class="bg-gray-800 rounded-lg p-4 border-2 border-gray-600">
                    <p class="text-center text-gray-400 mb-2">Posici√≥n del operador (seg√∫n sus movimientos):</p>
                    <p id="tech-pos-display" class="text-center text-2xl title-font text-purple-400">(?, ?)</p>
                    <p class="text-center text-gray-500 text-xs mt-2">No puedes ver su posici√≥n directamente</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- DOOR CLOSING ANIMATION -->
    <div id="door-animation" class="hidden fixed inset-0 z-[90] pointer-events-none">
        <div id="door-left" class="absolute top-0 left-0 w-1/2 h-full bg-gray-800 border-r-4 border-yellow-600 transform -translate-x-full transition-transform duration-1000 ease-in-out">
            <div class="absolute inset-0 flex items-center justify-end pr-8">
                <div class="text-6xl">üîí</div>
            </div>
            <div class="absolute top-1/2 right-0 transform translate-x-1/2 -translate-y-1/2">
                <div class="w-8 h-24 bg-yellow-600 rounded-full border-4 border-yellow-400"></div>
            </div>
        </div>
        <div id="door-right" class="absolute top-0 right-0 w-1/2 h-full bg-gray-800 border-l-4 border-yellow-600 transform translate-x-full transition-transform duration-1000 ease-in-out">
            <div class="absolute inset-0 flex items-center justify-start pl-8">
                <div class="text-6xl">üîí</div>
            </div>
            <div class="absolute top-1/2 left-0 transform -translate-x-1/2 -translate-y-1/2">
                <div class="w-8 h-24 bg-yellow-600 rounded-full border-4 border-yellow-400"></div>
            </div>
        </div>
    </div>
    
    <!-- VICTORY SCREEN -->
    <div id="victory-screen" class="hidden fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center p-6 text-center overflow-hidden">
        <!-- Animated background particles -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute w-2 h-2 bg-green-500 rounded-full animate-ping" style="top: 20%; left: 30%;"></div>
            <div class="absolute w-2 h-2 bg-green-400 rounded-full animate-ping" style="top: 60%; left: 70%; animation-delay: 0.5s;"></div>
            <div class="absolute w-2 h-2 bg-green-300 rounded-full animate-ping" style="top: 40%; left: 50%; animation-delay: 1s;"></div>
            <div class="absolute w-3 h-3 bg-yellow-500 rounded-full animate-ping" style="top: 80%; left: 20%; animation-delay: 0.3s;"></div>
            <div class="absolute w-3 h-3 bg-yellow-400 rounded-full animate-ping" style="top: 10%; left: 80%; animation-delay: 0.7s;"></div>
        </div>
        
        <div class="relative z-10 glow-green p-8 border-4 border-green-500 bg-gray-900 max-w-md w-full rounded-lg">
            <!-- Trophy icon with animation -->
            <div class="text-7xl mb-4 animate-bounce">üèÜ</div>
            
            <h1 class="title-font text-4xl text-green-500 mb-2 flicker">MISI√ìN CUMPLIDA</h1>
            <p class="text-green-300 text-sm mb-6">El b√∫nker ha sido sellado con √©xito</p>
            
            <!-- Stats terminal -->
            <div class="space-y-3 font-mono text-left bg-black p-4 border-2 border-green-900 rounded mb-6">
                <div class="flex justify-between items-center border-b border-green-900 pb-2">
                    <span class="text-green-400">ESTADO:</span>
                    <span class="text-white font-bold">B√öNKER SELLADO ‚úì</span>
                </div>
                <div class="flex justify-between items-center border-b border-green-900 pb-2">
                    <span class="text-green-400">TIEMPO TOTAL:</span>
                    <span id="victory-time" class="text-white font-bold title-font text-xl">00:00</span>
                </div>
                <div class="flex justify-between items-center border-b border-green-900 pb-2">
                    <span class="text-green-400">ERRORES:</span>
                    <span id="victory-errors" class="text-white font-bold title-font text-xl">0</span>
                </div>
                <div class="flex justify-between items-center border-b border-green-900 pb-2">
                    <span class="text-green-400">EFICIENCIA:</span>
                    <span id="victory-efficiency" class="text-cyan-400 font-bold">---%</span>
                </div>
                <div class="flex justify-between items-center pt-2">
                    <span class="text-green-400">RANGO:</span>
                    <span id="victory-rank" class="text-yellow-500 font-bold title-font text-2xl">---</span>
                </div>
            </div>
            
            <!-- Rank description -->
            <div id="rank-description" class="text-gray-400 text-sm mb-6 h-12 flex items-center justify-center">
                <span id="rank-desc-text"></span>
            </div>
            
            <!-- Team evaluation -->
            <div class="bg-gray-800 rounded p-3 mb-6 border border-gray-700">
                <p class="text-xs text-gray-500 mb-2">EVALUACI√ìN DEL EQUIPO</p>
                <div class="flex justify-center gap-1" id="star-rating">
                    <!-- Stars will be added by JS -->
                </div>
            </div>
            
            <button onclick="location.reload()" class="w-full bg-green-700 hover:bg-green-600 text-white p-4 font-bold transition-all hover:scale-105 title-font text-lg rounded border-2 border-green-500">
                üîÑ REINICIAR SISTEMA
            </button>
            
            <p class="text-gray-600 text-xs mt-4">Gracias por jugar El B√∫nker</p>
        </div>
    </div>
    
    <!-- SUCCESS SCREEN (legacy, kept for compatibility) -->
    <div id="success-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black overflow-hidden">
        <div id="success-bg" class="absolute inset-0 green-pulse"></div>
        
        <div class="text-center relative z-10">
            <div id="success-icon" class="text-8xl mb-6 stabilize-animation">üèÜ</div>
            
            <h1 class="title-font text-4xl md:text-6xl text-green-400 glow-green mb-4">
                ¬°B√öNKER ESCAPADO!
            </h1>
            
            <p class="text-green-300 text-xl mb-6">Todos los niveles completados</p>
            
            <div class="bg-gray-900/80 border-2 border-green-500 rounded-lg p-6 mb-6 max-w-md mx-auto">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-black/50 p-3 rounded">
                        <p class="text-gray-500">Errores totales</p>
                        <p id="final-errors" class="text-2xl text-white title-font">0</p>
                    </div>
                    <div class="bg-black/50 p-3 rounded">
                        <p class="text-gray-500">Tiempo total</p>
                        <p id="final-time" class="text-2xl text-white title-font">00:00</p>
                    </div>
                </div>
            </div>
            
            <button onclick="location.reload()" class="bg-green-600 hover:bg-green-500 text-white py-4 px-8 rounded-lg title-font text-xl transition-all hover:scale-105 glow-green">
                üîÑ JUGAR DE NUEVO
            </button>
        </div>
    </div>
    
    <!-- Fullscreen Button -->
    <button id="fullscreen-btn" class="fs-button" title="Pantalla completa">‚õ∂</button>

    <script>
        // ============================================
        // AUDIO ENGINE
        // ============================================
        const AudioEngine = {
            ctx: null,
            enabled: true,
            ambientNode: null,
            ambientGain: null,
            
            init() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            
            resume() {
                if (this.ctx && this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            
            playSpark() {
                if (!this.enabled || !this.ctx) return;
                this.resume();
                if (navigator.vibrate) navigator.vibrate(50);
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.15);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.15);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.15);
            },
            
            playConnect() {
                if (!this.enabled || !this.ctx) return;
                this.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, this.ctx.currentTime);
                osc.frequency.setValueAtTime(660, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.2);
            },
            
            playError() {
                if (!this.enabled || !this.ctx) return;
                this.resume();
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.5);
            },
            
            playSuccess() {
                if (!this.enabled || !this.ctx) return;
                this.resume();
                const notes = [523.25, 659.25, 783.99, 1046.50];
                notes.forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, this.ctx.currentTime + i * 0.15);
                    gain.gain.linearRampToValueAtTime(0.2, this.ctx.currentTime + i * 0.15 + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + i * 0.15 + 0.4);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(this.ctx.currentTime + i * 0.15);
                    osc.stop(this.ctx.currentTime + i * 0.15 + 0.4);
                });
            },
            
            playBeepShort() {
                if (!this.enabled || !this.ctx) return;
                this.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 800;
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.15);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.15);
            },
            
            playBeepLong() {
                if (!this.enabled || !this.ctx) return;
                this.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 600;
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.5);
            },
            
            playCharge() {
                if (!this.enabled || !this.ctx) return;
                this.resume();
                if (navigator.vibrate) navigator.vibrate(100);
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, this.ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.3);
            },
            
            startAmbient() {
                if (!this.enabled || !this.ctx || this.ambientNode) return;
                this.resume();
                this.ambientNode = this.ctx.createOscillator();
                this.ambientGain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();
                this.ambientNode.type = 'sawtooth';
                this.ambientNode.frequency.value = 60;
                filter.type = 'lowpass';
                filter.frequency.value = 200;
                this.ambientGain.gain.value = 0.05;
                this.ambientNode.connect(filter);
                filter.connect(this.ambientGain);
                this.ambientGain.connect(this.ctx.destination);
                this.ambientNode.start();
            },
            
            stopAmbient() {
                if (this.ambientNode) {
                    this.ambientNode.stop();
                    this.ambientNode = null;
                }
            },
            
            toggle() {
                this.enabled = !this.enabled;
                if (!this.enabled) this.stopAmbient();
                return this.enabled;
            }
        };
        
        // ============================================
        // GAME STATE
        // ============================================
        const state = {
            gameId: null,
            playerRole: null,
            currentLevel: 1,
            totalErrors: 0,
            startTime: null,
            peer: null,
            conn: null,
            
            // Level 1: Wires
            connections: { red: null, blue: null, green: null, yellow: null },
            selectedWire: null,
            locked: false,
            lockdownTriggered: false,
            lockdownCode: null,
            keypadInput: '',
            
            // Level 2: Reactor
            reactorCycles: 0,
            reactorFails: 0,
            pistonPhase: 0,
            pistonInterval: null,
            reactorStartTime: null,
            reactorRhythmInterval: null,
            lastTargetTime: null,
            syncBarAnimating: false,
            cycleDuration: 1500, // 1.5 seconds per cycle
            
            // Level 3: Radio
            currentPattern: null,
            signalsDecoded: { oxygen: false, door: false, power: false, vent: false },
            patterns: {
                oxygen: ['short', 'short', 'short'],
                door: ['long'],
                power: ['short', 'long', 'short'],
                vent: ['long', 'long']
            },
            patternQueue: [],
            
            // Level 4: Maze
            playerPos: { x: 1, y: 1 },
            mazeLayout: [
                [1,1,1,1,1,1,1],
                [1,0,0,0,1,0,1],
                [1,0,1,0,0,0,1],
                [1,0,1,1,1,0,1],
                [1,0,0,2,0,0,1],
                [1,1,0,1,0,3,1],
                [1,1,1,1,1,1,1]
            ]
            // 0=path, 1=wall, 2=mine, 3=exit
        };
        
        // Solutions
        const WIRE_SOLUTION = { red: '1', blue: '3', green: '2', yellow: '4' };
        
        // ============================================
        // DOM ELEMENTS
        // ============================================
        const lobbyScreen = document.getElementById('lobby-screen');
        const playerAScreen = document.getElementById('player-a-screen');
        const playerBScreen = document.getElementById('player-b-screen');
        const successScreen = document.getElementById('success-screen');
        const createBtn = document.getElementById('create-btn');
        const joinBtn = document.getElementById('join-btn');
        const linkSection = document.getElementById('link-section');
        const joinSection = document.getElementById('join-section');
        const gameLink = document.getElementById('game-link');
        const copyBtn = document.getElementById('copy-btn');
        
        // ============================================
        // NETWORKING
        // ============================================
        function generateGameId() {
            return 'bunker-' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function initializePeer(isHost) {
            return new Promise((resolve, reject) => {
                const peerId = isHost ? state.gameId : null;
                state.peer = new Peer(peerId, { debug: 1 });
                
                state.peer.on('open', (id) => {
                    if (isHost) state.gameId = id;
                    resolve(id);
                });
                
                state.peer.on('error', (err) => {
                    if (err.type === 'unavailable-id') {
                        state.gameId = generateGameId();
                        initializePeer(true).then(resolve).catch(reject);
                    } else {
                        document.getElementById('connection-error').classList.remove('hidden');
                        reject(err);
                    }
                });
                
                if (isHost) {
                    state.peer.on('connection', (conn) => {
                        state.conn = conn;
                        setupConnection(conn);
                    });
                }
            });
        }
        
        function connectToPeer(hostId) {
            return new Promise((resolve, reject) => {
                state.conn = state.peer.connect(hostId, { reliable: true });
                state.conn.on('open', () => {
                    setupConnection(state.conn);
                    resolve();
                });
                state.conn.on('error', reject);
            });
        }
        
        function setupConnection(conn) {
            conn.on('data', handleMessage);
            conn.on('close', () => updateConnectionStatus(false));
        }
        
        function sendMessage(type, data = {}) {
            if (state.conn && state.conn.open) {
                state.conn.send({ type, data });
            }
        }
        
        function handleMessage(msg) {
            const { type, data } = msg;
            
            switch (type) {
                case 'player-joined':
                    startGame();
                    sendMessage('game-state', { currentLevel: state.currentLevel });
                    break;
                    
                case 'game-state':
                    state.currentLevel = data.currentLevel || 1;
                    break;
                    
                // Level 1 messages
                case 'connection-update':
                    state.connections = data.connections;
                    state.totalErrors = data.errorCount || state.totalErrors;
                    updateLiveStatus();
                    break;
                    
                case 'error-occurred':
                    showAlert('¬°SOBRECARGA!', 'Conexi√≥n incorrecta');
                    AudioEngine.playError();
                    state.totalErrors = data.errorCount;
                    break;
                    
                case 'trigger-lockdown':
                    handleLockdownTrigger(data);
                    break;
                    
                case 'code-attempt':
                    if (data.code === state.lockdownCode) {
                        unlockSystem();
                        sendMessage('code-success');
                    }
                    break;
                    
                case 'code-success':
                    handleCodeSuccess();
                    break;
                    
                case 'level-complete':
                    transitionToLevel(data.nextLevel);
                    break;
                    
                // Level 2 messages
                case 'reactor-sync':
                    // Sync reactor timing with operator
                    state.reactorStartTime = data.startTime;
                    state.cycleDuration = data.cycleDuration || 1500;
                    if (state.playerRole === 'B' && state.currentLevel === 2) {
                        startOscilloscope();
                    }
                    break;
                    
                case 'pulse-check':
                    // Technician validates the operator's timing
                    if (state.playerRole === 'B') {
                        handlePulseCheck(data);
                    }
                    break;
                    
                case 'pulse-result':
                    // Operator receives result from technician
                    if (state.playerRole === 'A') {
                        handlePulseResult(data);
                    }
                    break;
                    
                case 'charge-pressed':
                    handleChargeResult(data);
                    break;
                    
                case 'reactor-update':
                    updateReactorStatus(data);
                    break;
                    
                // Level 3 messages
                case 'pattern-playing':
                    // Player B knows a pattern is playing
                    break;
                    
                case 'switch-activated':
                    handleSwitchResult(data);
                    break;
                    
                case 'signal-decoded':
                    updateSignalStatus(data);
                    break;
                    
                // Level 4 messages
                case 'player-moved':
                    handlePlayerMove(data);
                    break;
                    
                case 'maze-result':
                    handleMazeResult(data);
                    break;
                    
                case 'game-complete':
                    showFinalSuccess();
                    break;
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusA = document.getElementById('connection-status-a');
            const statusB = document.getElementById('connection-status-b');
            const cls = connected ? 'text-green-400' : 'text-red-400';
            const txt = connected ? '‚óè Conectado' : '‚óè Desconectado';
            if (statusA) { statusA.textContent = txt; statusA.className = cls; }
            if (statusB) { statusB.textContent = txt; statusB.className = cls; }
        }
        
        // ============================================
        // GAME FLOW
        // ============================================
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');
            
            if (gameId) {
                state.gameId = gameId;
                joinSection.classList.remove('hidden');
                createBtn.classList.add('hidden');
            }
            
            document.addEventListener('click', () => {
                if (!AudioEngine.ctx) AudioEngine.init();
            }, { once: true });
        }
        
        createBtn.addEventListener('click', async () => {
            createBtn.disabled = true;
            createBtn.textContent = '‚è≥ Conectando...';
            
            try {
                state.gameId = generateGameId();
                state.playerRole = 'A';
                await initializePeer(true);
                
                const url = `${window.location.origin}${window.location.pathname}?game=${state.gameId}`;
                gameLink.value = url;
                linkSection.classList.remove('hidden');
                createBtn.classList.add('hidden');
            } catch (err) {
                createBtn.disabled = false;
                createBtn.textContent = '‚ö° CREAR PARTIDA';
            }
        });
        
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(gameLink.value);
            copyBtn.textContent = '‚úì';
            setTimeout(() => copyBtn.textContent = 'üìã', 2000);
        });
        
        joinBtn.addEventListener('click', async () => {
            joinBtn.disabled = true;
            joinBtn.textContent = '‚è≥ Conectando...';
            
            try {
                state.playerRole = 'B';
                await initializePeer(false);
                await connectToPeer(state.gameId);
                sendMessage('player-joined');
                startGame();
            } catch (err) {
                joinBtn.disabled = false;
                joinBtn.textContent = 'UNIRSE COMO T√âCNICO';
                document.getElementById('connection-error').classList.remove('hidden');
            }
        });
        
        function startGame() {
            lobbyScreen.classList.add('hidden');
            updateConnectionStatus(true);
            state.startTime = Date.now();
            
            if (state.playerRole === 'A') {
                playerAScreen.classList.remove('hidden');
                setupLevel1A();
                AudioEngine.startAmbient();
                document.getElementById('sound-toggle-a').addEventListener('click', () => {
                    const enabled = AudioEngine.toggle();
                    document.getElementById('sound-toggle-a').textContent = enabled ? 'üîä' : 'üîá';
                });
            } else {
                playerBScreen.classList.remove('hidden');
                setupLevel1B();
                document.getElementById('sound-toggle-b').addEventListener('click', () => {
                    const enabled = AudioEngine.toggle();
                    document.getElementById('sound-toggle-b').textContent = enabled ? 'üîä' : 'üîá';
                });
            }
            
            document.getElementById('waiting-indicator')?.classList.add('hidden');
        }
        
        function transitionToLevel(level) {
            // Clean up previous level
            if (state.reactorRhythmInterval) {
                clearInterval(state.reactorRhythmInterval);
                state.reactorRhythmInterval = null;
            }
            
            state.currentLevel = level;
            
            // Update indicators
            const indicatorA = document.getElementById('level-indicator-a');
            const indicatorB = document.getElementById('level-indicator-b');
            if (indicatorA) indicatorA.textContent = `NIVEL ${level}`;
            if (indicatorB) indicatorB.textContent = `NIVEL ${level}`;
            
            // Hide all level containers
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`level-${i}-a`)?.classList.add('hidden');
                document.getElementById(`level-${i}-b`)?.classList.add('hidden');
            }
            
            // Show current level
            if (state.playerRole === 'A') {
                document.getElementById(`level-${level}-a`)?.classList.remove('hidden');
                setupLevelA(level);
            } else {
                document.getElementById(`level-${level}-b`)?.classList.remove('hidden');
                setupLevelB(level);
            }
            
            AudioEngine.playSuccess();
        }
        
        function setupLevelA(level) {
            switch(level) {
                case 2: setupLevel2A(); break;
                case 3: setupLevel3A(); break;
                case 4: setupLevel4A(); break;
            }
        }
        
        function setupLevelB(level) {
            switch(level) {
                case 2: setupLevel2B(); break;
                case 3: setupLevel3B(); break;
                case 4: setupLevel4B(); break;
            }
        }
        
        function showAlert(title, message) {
            const popup = document.getElementById('alert-popup');
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            popup.classList.remove('hidden');
            setTimeout(() => popup.classList.add('hidden'), 2000);
        }
        
        // ============================================
        // LEVEL 1: WIRES
        // ============================================
        function setupLevel1A() {
            const wires = document.querySelectorAll('.wire');
            const terminals = document.querySelectorAll('.terminal');
            const svg = document.getElementById('connection-svg');
            
            wires.forEach(wire => {
                wire.addEventListener('click', () => {
                    if (state.locked) return;
                    AudioEngine.playSpark();
                    
                    wires.forEach(w => w.classList.remove('ring-4', 'ring-white'));
                    terminals.forEach(t => t.classList.remove('highlight'));
                    
                    state.selectedWire = wire.dataset.color;
                    wire.classList.add('ring-4', 'ring-white');
                    terminals.forEach(t => t.classList.add('highlight'));
                });
            });
            
            terminals.forEach(terminal => {
                terminal.addEventListener('click', () => {
                    if (!state.selectedWire || state.locked) return;
                    
                    const terminalNum = terminal.dataset.terminal;
                    
                    // Prevent double-click on same connection
                    if (state.connections[state.selectedWire] === terminalNum) {
                        wires.forEach(w => w.classList.remove('ring-4', 'ring-white'));
                        terminals.forEach(t => t.classList.remove('highlight'));
                        state.selectedWire = null;
                        return;
                    }
                    
                    // Clear old connection
                    const oldTerminal = state.connections[state.selectedWire];
                    if (oldTerminal) {
                        document.getElementById(`terminal-${oldTerminal}`)?.classList.remove('connected', 'occupied');
                    }
                    
                    // Clear terminal if occupied by another wire
                    Object.keys(state.connections).forEach(color => {
                        if (state.connections[color] === terminalNum) {
                            state.connections[color] = null;
                            updateConnectionDisplay(color, null);
                        }
                    });
                    
                    // Make connection
                    state.connections[state.selectedWire] = terminalNum;
                    terminal.classList.add('connected', 'occupied');
                    
                    AudioEngine.playConnect();
                    
                    if (WIRE_SOLUTION[state.selectedWire] !== terminalNum) {
                        state.totalErrors++;
                        document.getElementById('error-count').textContent = state.totalErrors;
                        document.getElementById('error-overlay').classList.add('error-flash');
                        setTimeout(() => document.getElementById('error-overlay').classList.remove('error-flash'), 500);
                        AudioEngine.playError();
                        sendMessage('error-occurred', { errorCount: state.totalErrors });
                    }
                    
                    updateConnectionDisplay(state.selectedWire, terminalNum);
                    drawConnections();
                    
                    sendMessage('connection-update', {
                        connections: state.connections,
                        errorCount: state.totalErrors
                    });
                    
                    checkLevel1Solution();
                    
                    wires.forEach(w => w.classList.remove('ring-4', 'ring-white'));
                    terminals.forEach(t => t.classList.remove('highlight'));
                    state.selectedWire = null;
                });
            });
            
            document.getElementById('reset-wires').addEventListener('click', () => {
                if (state.locked) return;
                state.connections = { red: null, blue: null, green: null, yellow: null };
                terminals.forEach(t => t.classList.remove('connected', 'occupied'));
                ['red', 'blue', 'green', 'yellow'].forEach(c => updateConnectionDisplay(c, null));
                svg.innerHTML = '';
                AudioEngine.playSpark();
                sendMessage('connection-update', { connections: state.connections, errorCount: state.totalErrors });
            });
        }
        
        function setupLevel1B() {
            const keypadBtns = document.querySelectorAll('.keypad-btn');
            const keypadDisplay = document.getElementById('keypad-display');
            
            keypadBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const num = btn.dataset.num;
                    AudioEngine.playSpark();
                    
                    if (num === 'clear') {
                        state.keypadInput = '';
                        keypadDisplay.textContent = '----';
                    } else if (num === 'enter') {
                        if (state.keypadInput.length === 4) {
                            sendMessage('code-attempt', { code: state.keypadInput });
                        }
                    } else {
                        if (state.keypadInput.length < 4) {
                            state.keypadInput += num;
                            keypadDisplay.textContent = state.keypadInput.padEnd(4, '-');
                        }
                    }
                });
            });
        }
        
        function updateConnectionDisplay(color, terminal) {
            const el = document.getElementById(`${color}-conn`);
            if (el) {
                el.textContent = terminal ? `Borne ${terminal}` : '---';
                el.classList.toggle('text-green-400', terminal !== null);
            }
        }
        
        function drawConnections() {
            const svg = document.getElementById('connection-svg');
            const container = svg.parentElement;
            svg.innerHTML = '';
            
            const colors = { red: '#ef4444', blue: '#3b82f6', green: '#22c55e', yellow: '#eab308' };
            
            Object.keys(state.connections).forEach(color => {
                const terminal = state.connections[color];
                if (!terminal) return;
                
                const wire = document.getElementById(`wire-${color}`);
                const term = document.getElementById(`terminal-${terminal}`);
                
                const wireRect = wire.getBoundingClientRect();
                const termRect = term.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                const x1 = wireRect.right - containerRect.left;
                const y1 = wireRect.top + wireRect.height/2 - containerRect.top;
                const x2 = termRect.left - containerRect.left;
                const y2 = termRect.top + termRect.height/2 - containerRect.top;
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke', colors[color]);
                line.setAttribute('stroke-width', '4');
                line.setAttribute('class', 'connection-line');
                svg.appendChild(line);
            });
        }
        
        function updateLiveStatus() {
            Object.keys(state.connections).forEach(color => {
                const el = document.getElementById(`live-${color}`);
                if (el) {
                    const terminal = state.connections[color];
                    el.textContent = terminal ? `Borne ${terminal}` : '---';
                    const isCorrect = terminal === WIRE_SOLUTION[color];
                    el.classList.remove('text-green-400', 'text-red-400');
                    if (terminal) el.classList.add(isCorrect ? 'text-green-400' : 'text-red-400');
                }
            });
            
            let correct = 0;
            Object.keys(WIRE_SOLUTION).forEach(color => {
                if (state.connections[color] === WIRE_SOLUTION[color]) correct++;
            });
            document.getElementById('correct-count').textContent = correct;
        }
        
        function checkLevel1Solution() {
            // Count correct connections
            let correct = 0;
            Object.keys(WIRE_SOLUTION).forEach(color => {
                if (state.connections[color] === WIRE_SOLUTION[color]) correct++;
            });
            
            // Trigger lockdown at 2 correct (if not already locked)
            if (correct >= 2 && !state.locked && !state.lockdownTriggered) {
                state.lockdownTriggered = true;
                triggerLockdown();
                return; // Don't check for completion yet
            }
            
            // Check complete solution (all 4 correct AND system unlocked)
            if (correct === 4 && !state.locked) {
                completeLevel1();
            }
        }
        
        function triggerLockdown() {
            state.locked = true;
            state.lockdownCode = Math.floor(1000 + Math.random() * 9000).toString();
            
            document.getElementById('lockdown-display').classList.remove('hidden');
            document.getElementById('lockdown-code').textContent = state.lockdownCode;
            document.querySelectorAll('.wire').forEach(w => w.classList.add('locked'));
            document.querySelectorAll('.terminal').forEach(t => t.classList.add('locked'));
            
            AudioEngine.playError();
            sendMessage('trigger-lockdown', { code: state.lockdownCode });
        }
        
        function handleLockdownTrigger(data) {
            state.locked = true;
            state.lockdownCode = data.code;
            document.getElementById('security-keypad-container').classList.remove('hidden');
            AudioEngine.playError();
            showAlert('üîí BLOQUEADO', 'Ingresa el c√≥digo del operador');
        }
        
        function unlockSystem() {
            state.locked = false;
            document.getElementById('lockdown-display').classList.add('hidden');
            document.querySelectorAll('.wire').forEach(w => w.classList.remove('locked'));
            document.querySelectorAll('.terminal').forEach(t => t.classList.remove('locked'));
            AudioEngine.playSuccess();
        }
        
        function handleCodeSuccess() {
            state.locked = false;
            document.getElementById('security-keypad-container').classList.add('hidden');
            AudioEngine.playSuccess();
            showAlert('‚úì DESBLOQUEADO', 'Sistema operativo');
        }
        
        function completeLevel1() {
            AudioEngine.playSuccess();
            sendMessage('level-complete', { nextLevel: 2 });
            setTimeout(() => transitionToLevel(2), 1500);
        }
        
        // ============================================
        // LEVEL 2: REACTOR
        // ============================================
        function setupLevel2A() {
            const chargeBtn = document.getElementById('charge-btn');
            const piston = document.getElementById('reactor-piston');
            const energyLevel = document.getElementById('energy-level');
            
            // Reset reactor state
            state.reactorCycles = 0;
            state.reactorFails = 0;
            state.cycleDuration = 1500; // 1.5 seconds per cycle
            
            // Sync start time with technician
            state.reactorStartTime = Date.now();
            sendMessage('reactor-sync', { 
                startTime: state.reactorStartTime,
                cycleDuration: state.cycleDuration
            });
            
            // Update piston animation speed
            piston.style.setProperty('--piston-speed', `${state.cycleDuration}ms`);
            
            // Visual feedback on button
            let canPress = true;
            
            chargeBtn.addEventListener('click', () => {
                if (!canPress) return;
                
                AudioEngine.playCharge();
                canPress = false;
                chargeBtn.classList.add('opacity-50');
                
                // Send pulse to technician for validation
                const clickTime = Date.now();
                sendMessage('pulse-check', { time: clickTime });
                
                document.getElementById('timing-feedback').textContent = '‚è≥ Verificando...';
                document.getElementById('timing-feedback').className = 'mt-4 text-center text-yellow-400';
                
                // Reset button after cooldown (result will come from technician)
                setTimeout(() => {
                    canPress = true;
                    chargeBtn.classList.remove('opacity-50', 'ring-4', 'ring-green-400', 'ring-red-500');
                    if (!document.getElementById('timing-feedback').classList.contains('text-green-400') &&
                        !document.getElementById('timing-feedback').classList.contains('text-red-400')) {
                        document.getElementById('timing-feedback').textContent = 'Espera la se√±al del t√©cnico...';
                        document.getElementById('timing-feedback').className = 'mt-4 text-center text-gray-500';
                    }
                }, 800);
            });
        }
        
        // Oscilloscope sync bar animation for technician
        function startOscilloscope() {
            const bar = document.getElementById('sync-bar');
            if (!bar || state.syncBarAnimating) return;
            
            state.syncBarAnimating = true;
            const cycleDuration = state.cycleDuration || 1500;
            
            function animate() {
                if (state.currentLevel !== 2) {
                    state.syncBarAnimating = false;
                    return;
                }
                
                // Reset bar to left without transition
                bar.style.transition = 'none';
                bar.style.left = '0%';
                
                // Force browser to process position change
                bar.offsetHeight;
                
                // Move to right with smooth transition
                bar.style.transition = `left ${cycleDuration / 1000}s linear`;
                bar.style.left = '100%';
                
                // When bar reaches target zone (center), update lastTargetTime
                setTimeout(() => {
                    if (state.currentLevel === 2) {
                        state.lastTargetTime = Date.now();
                        
                        // Flash the target zone
                        const targetZone = bar.parentElement.querySelector('.bg-green-500\\/20');
                        if (targetZone) {
                            targetZone.classList.add('target-active');
                            setTimeout(() => targetZone.classList.remove('target-active'), 300);
                        }
                        
                        // Update rhythm counter
                        const rhythmCounter = document.getElementById('rhythm-counter');
                        if (rhythmCounter) {
                            rhythmCounter.textContent = '¬°YA!';
                            rhythmCounter.className = 'text-center text-5xl title-font text-green-400 font-black h-20 flex items-center justify-center';
                            AudioEngine.playBeepShort();
                        }
                    }
                }, cycleDuration * 0.5); // 50% of cycle = center
                
                // Restart animation
                setTimeout(() => {
                    if (state.currentLevel === 2) {
                        animate();
                    } else {
                        state.syncBarAnimating = false;
                    }
                }, cycleDuration + 50); // Small margin for restart
            }
            
            animate();
        }
        
        // Technician validates operator's pulse timing
        function handlePulseCheck(data) {
            const clickTime = data.time;
            const diff = Math.abs(clickTime - state.lastTargetTime);
            const tolerance = 250; // 250ms tolerance
            const perfectTolerance = 100; // 100ms for perfect
            
            let result;
            if (diff < perfectTolerance) {
                result = { success: true, perfect: true, diff: diff };
            } else if (diff < tolerance) {
                result = { success: true, perfect: false, diff: diff };
            } else {
                result = { success: false, perfect: false, diff: diff };
            }
            
            // Handle locally for technician UI
            if (result.success) {
                state.reactorCycles++;
                AudioEngine.playSuccess();
                
                // Update counters
                document.getElementById('tech-cycles').textContent = `${state.reactorCycles}/5`;
                
                // Visual feedback
                const rhythmCounter = document.getElementById('rhythm-counter');
                rhythmCounter.textContent = result.perfect ? '‚òÖ‚òÖ‚òÖ' : '‚úì BIEN';
                rhythmCounter.className = 'text-center text-5xl title-font text-green-400 h-20 flex items-center justify-center';
                
                if (state.reactorCycles >= 5) {
                    // Level complete - notify operator
                    sendMessage('pulse-result', { 
                        success: true, 
                        perfect: result.perfect, 
                        cycles: state.reactorCycles,
                        fails: state.reactorFails,
                        complete: true 
                    });
                    completeLevel2();
                    return;
                }
            } else {
                state.reactorFails++;
                state.totalErrors++;
                AudioEngine.playError();
                
                // Update counters
                document.getElementById('tech-fails').textContent = `${state.reactorFails}/3`;
                
                // Visual feedback
                const rhythmCounter = document.getElementById('rhythm-counter');
                rhythmCounter.textContent = '‚úó FALLO';
                rhythmCounter.className = 'text-center text-5xl title-font text-red-400 h-20 flex items-center justify-center';
                
                showAlert('¬°FALLO!', `${result.diff}ms fuera de tiempo`);
                
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                
                if (state.reactorFails >= 3) {
                    showAlert('üî• CR√çTICO', '¬°Demasiados fallos!');
                }
            }
            
            // Send result back to operator
            sendMessage('pulse-result', { 
                success: result.success, 
                perfect: result.perfect,
                diff: result.diff,
                cycles: state.reactorCycles,
                fails: state.reactorFails,
                complete: false
            });
        }
        
        // Operator receives pulse result from technician
        function handlePulseResult(data) {
            const chargeBtn = document.getElementById('charge-btn');
            const piston = document.getElementById('reactor-piston');
            const energyLevel = document.getElementById('energy-level');
            
            state.reactorCycles = data.cycles;
            state.reactorFails = data.fails;
            
            // Update displays
            document.getElementById('cycle-count').textContent = `${data.cycles}/5`;
            document.getElementById('reactor-fails').textContent = data.fails;
            energyLevel.style.height = `${(data.cycles / 5) * 100}%`;
            
            if (data.success) {
                if (data.perfect) {
                    document.getElementById('timing-feedback').textContent = '‚òÖ ¬°PERFECTO! ‚òÖ';
                    document.getElementById('timing-feedback').className = 'mt-4 text-center text-green-400 font-bold text-xl';
                } else {
                    document.getElementById('timing-feedback').textContent = '‚úì ¬°Bien!';
                    document.getElementById('timing-feedback').className = 'mt-4 text-center text-green-400 font-bold';
                }
                
                chargeBtn.classList.add('ring-4', 'ring-green-400');
                piston.style.boxShadow = '0 0 30px #00ff00';
                setTimeout(() => {
                    piston.style.boxShadow = '';
                    chargeBtn.classList.remove('ring-4', 'ring-green-400');
                }, 500);
                
                AudioEngine.playSuccess();
                
                if (data.complete) {
                    completeLevel2();
                }
            } else {
                document.getElementById('timing-feedback').textContent = `‚úó ¬°${data.diff}ms fuera de tiempo!`;
                document.getElementById('timing-feedback').className = 'mt-4 text-center text-red-400 font-bold';
                document.getElementById('overheat-warning').classList.remove('hidden');
                
                chargeBtn.classList.add('ring-4', 'ring-red-500');
                piston.style.boxShadow = '0 0 30px #ff0000';
                document.getElementById('error-overlay').classList.add('error-flash');
                
                setTimeout(() => {
                    piston.style.boxShadow = '';
                    chargeBtn.classList.remove('ring-4', 'ring-red-500');
                    document.getElementById('error-overlay').classList.remove('error-flash');
                }, 500);
                
                AudioEngine.playError();
                
                if (data.fails >= 3) {
                    document.getElementById('timing-feedback').textContent = 'üî• ¬°SOBRECALENTAMIENTO CR√çTICO!';
                    chargeBtn.disabled = true;
                }
            }
            
            // Reset feedback after delay
            setTimeout(() => {
                if (state.currentLevel === 2 && !chargeBtn.disabled) {
                    document.getElementById('timing-feedback').textContent = 'Espera la se√±al del t√©cnico...';
                    document.getElementById('timing-feedback').className = 'mt-4 text-center text-gray-500';
                }
            }, 1500);
        }
        
        function setupLevel2B() {
            const rhythmCounter = document.getElementById('rhythm-counter');
            const peakInterval = document.getElementById('peak-interval');
            const wave = document.getElementById('oscilloscope-wave');
            
            // Reset state
            state.reactorCycles = 0;
            state.reactorFails = 0;
            state.lastTargetTime = Date.now();
            
            // Update displays
            document.getElementById('tech-cycles').textContent = '0/5';
            document.getElementById('tech-fails').textContent = '0/3';
            
            // Set cycle duration display
            peakInterval.textContent = `${(state.cycleDuration / 1000).toFixed(1)}s`;
            
            // Update wave animation speed to match
            wave.style.setProperty('--wave-speed', `${state.cycleDuration}ms`);
            
            // Start the oscilloscope sync bar
            startOscilloscope();
            
            // Rhythm indicator that syncs with sync bar
            const rhythmInterval = setInterval(() => {
                if (state.currentLevel !== 2) {
                    clearInterval(rhythmInterval);
                    return;
                }
                
                // Calculate time since last target
                const timeSinceTarget = Date.now() - state.lastTargetTime;
                const phase = (timeSinceTarget % state.cycleDuration) / state.cycleDuration;
                
                // Update countdown display
                const timeToNext = ((1 - phase) * state.cycleDuration) / 1000;
                const countdownEl = document.getElementById('peak-countdown');
                if (countdownEl) {
                    countdownEl.textContent = `${timeToNext.toFixed(1)}s`;
                }
                
                // Visual rhythm feedback (outside of peak moments)
                if (phase > 0.15 && phase < 0.35) {
                    rhythmCounter.textContent = '...';
                    rhythmCounter.className = 'text-center text-5xl title-font text-yellow-400 h-20 flex items-center justify-center';
                } else if (phase > 0.55 && phase < 0.7) {
                    rhythmCounter.textContent = '‚óã';
                    rhythmCounter.className = 'text-center text-5xl title-font text-gray-500 h-20 flex items-center justify-center';
                } else if (phase > 0.7) {
                    rhythmCounter.textContent = '‚óè';
                    rhythmCounter.className = 'text-center text-6xl title-font text-orange-400 h-20 flex items-center justify-center';
                }
                
            }, 50); // Update every 50ms for smooth animation
            
            state.reactorRhythmInterval = rhythmInterval;
        }
        
        function updateReactorStatus(data) {
            state.reactorCycles = data.cycles;
            state.reactorFails = data.fails;
            
            // Update UI on player B's screen
            if (state.playerRole === 'B') {
                const resultEl = document.getElementById('rhythm-counter');
                const cyclesEl = document.getElementById('tech-cycles');
                const failsEl = document.getElementById('tech-fails');
                
                // Update counters
                if (cyclesEl) cyclesEl.textContent = `${data.cycles}/5`;
                if (failsEl) failsEl.textContent = `${data.fails}/3`;
                
                if (data.result === 'success') {
                    resultEl.textContent = data.perfect ? '‚òÖ‚òÖ‚òÖ' : '‚úì BIEN';
                    resultEl.className = 'text-center text-5xl title-font text-green-400 h-20 flex items-center justify-center';
                    AudioEngine.playSuccess();
                    
                    // Flash effect on counter
                    if (cyclesEl) {
                        cyclesEl.classList.add('scale-125');
                        setTimeout(() => cyclesEl.classList.remove('scale-125'), 300);
                    }
                } else if (data.result === 'fail') {
                    resultEl.textContent = '‚úó FALLO';
                    resultEl.className = 'text-center text-5xl title-font text-red-400 h-20 flex items-center justify-center';
                    showAlert('¬°FALLO!', `${data.offBy}ms fuera de tiempo`);
                    AudioEngine.playError();
                    
                    // Flash effect on fail counter
                    if (failsEl) {
                        failsEl.classList.add('scale-125');
                        setTimeout(() => failsEl.classList.remove('scale-125'), 300);
                    }
                    
                    // Vibrate on mobile
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }
            }
        }
        
        function completeLevel2() {
            // Stop the sync bar animation
            state.syncBarAnimating = false;
            
            if (state.reactorRhythmInterval) {
                clearInterval(state.reactorRhythmInterval);
                state.reactorRhythmInterval = null;
            }
            
            AudioEngine.playSuccess();
            sendMessage('level-complete', { nextLevel: 3 });
            setTimeout(() => transitionToLevel(3), 1500);
        }
        
        // ============================================
        // LEVEL 3: RADIO
        // ============================================
        function setupLevel3A() {
            // Generate random pattern queue
            const patternTypes = ['oxygen', 'door', 'power', 'vent'];
            state.patternQueue = [...patternTypes].sort(() => Math.random() - 0.5);
            state.currentPattern = state.patternQueue[0];
            
            const playBtn = document.getElementById('play-pattern-btn');
            const patternVisual = document.getElementById('pattern-visual');
            const switches = document.querySelectorAll('.radio-switch');
            
            playBtn.addEventListener('click', () => {
                playCurrentPattern();
            });
            
            switches.forEach(sw => {
                sw.addEventListener('click', () => {
                    const switchType = sw.dataset.switch;
                    AudioEngine.playSpark();
                    
                    if (switchType === state.currentPattern) {
                        state.signalsDecoded[switchType] = true;
                        sw.classList.add('bg-green-600');
                        sw.disabled = true;
                        
                        const decoded = Object.values(state.signalsDecoded).filter(v => v).length;
                        document.getElementById('signals-decoded').textContent = decoded;
                        
                        sendMessage('signal-decoded', { signal: switchType });
                        
                        if (decoded >= 4) {
                            completeLevel3();
                        } else {
                            // Next pattern
                            state.patternQueue.shift();
                            state.currentPattern = state.patternQueue[0];
                        }
                    } else {
                        state.totalErrors++;
                        AudioEngine.playError();
                        showAlert('¬°ERROR!', 'Interruptor incorrecto');
                    }
                });
            });
        }
        
        function playCurrentPattern() {
            const pattern = state.patterns[state.currentPattern];
            const patternVisual = document.getElementById('pattern-visual');
            
            // Show visual pattern
            patternVisual.innerHTML = pattern.map(p => 
                `<div class="w-6 h-6 rounded-full ${p === 'short' ? 'bg-cyan-400' : 'bg-cyan-600 w-12'} flex-shrink-0"></div>`
            ).join('');
            
            // Play audio pattern
            let delay = 0;
            pattern.forEach(p => {
                setTimeout(() => {
                    if (p === 'short') {
                        AudioEngine.playBeepShort();
                    } else {
                        AudioEngine.playBeepLong();
                    }
                }, delay);
                delay += p === 'short' ? 300 : 700;
            });
            
            sendMessage('pattern-playing', { pattern: state.currentPattern });
        }
        
        function setupLevel3B() {
            // Just display the translation table - already in HTML
        }
        
        function updateSignalStatus(data) {
            const signalEl = document.getElementById(`signal-${data.signal}`);
            if (signalEl) {
                signalEl.textContent = '‚úì Decodificada';
                signalEl.className = 'text-green-400';
            }
        }
        
        function completeLevel3() {
            AudioEngine.playSuccess();
            sendMessage('level-complete', { nextLevel: 4 });
            setTimeout(() => transitionToLevel(4), 1500);
        }
        
        // ============================================
        // LEVEL 4: MAZE
        // ============================================
        function setupLevel4A() {
            const mazeView = document.getElementById('maze-player-view');
            state.playerPos = { x: 1, y: 1 };
            
            // Create player's view (no walls visible)
            renderPlayerMaze();
            
            // Movement controls
            document.querySelectorAll('.maze-move').forEach(btn => {
                btn.addEventListener('click', () => {
                    const dir = btn.dataset.dir;
                    movePlayer(dir);
                });
            });
            
            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                if (state.currentLevel !== 4) return;
                const keyMap = { ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right' };
                if (keyMap[e.key]) {
                    e.preventDefault();
                    movePlayer(keyMap[e.key]);
                }
            });
        }
        
        function renderPlayerMaze() {
            const mazeView = document.getElementById('maze-player-view');
            mazeView.innerHTML = '';
            
            for (let y = 0; y < 7; y++) {
                for (let x = 0; x < 7; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'maze-cell bg-gray-800';
                    
                    if (x === state.playerPos.x && y === state.playerPos.y) {
                        cell.classList.add('player');
                    }
                    
                    mazeView.appendChild(cell);
                }
            }
            
            document.getElementById('player-pos').textContent = `(${state.playerPos.x}, ${state.playerPos.y})`;
        }
        
        function movePlayer(dir) {
            const newPos = { ...state.playerPos };
            
            switch(dir) {
                case 'up': newPos.y--; break;
                case 'down': newPos.y++; break;
                case 'left': newPos.x--; break;
                case 'right': newPos.x++; break;
            }
            
            // Bounds check
            if (newPos.x < 0 || newPos.x >= 7 || newPos.y < 0 || newPos.y >= 7) {
                AudioEngine.playError();
                return;
            }
            
            const cell = state.mazeLayout[newPos.y][newPos.x];
            
            sendMessage('player-moved', { pos: newPos, dir });
            
            if (cell === 1) {
                // Wall
                state.totalErrors++;
                AudioEngine.playError();
                showAlert('¬°PARED!', 'No puedes pasar');
                sendMessage('maze-result', { result: 'wall', pos: state.playerPos });
            } else if (cell === 2) {
                // Mine
                state.totalErrors += 3;
                AudioEngine.playError();
                if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
                showAlert('üí• ¬°MINA!', 'Vuelves al inicio');
                state.playerPos = { x: 1, y: 1 };
                renderPlayerMaze();
                sendMessage('maze-result', { result: 'mine', pos: state.playerPos });
            } else if (cell === 3) {
                // Exit - Success!
                state.playerPos = newPos;
                renderPlayerMaze();
                AudioEngine.playSuccess();
                completeLevel4();
            } else {
                // Path - OK
                state.playerPos = newPos;
                renderPlayerMaze();
                AudioEngine.playSpark();
            }
        }
        
        function setupLevel4B() {
            const mazeView = document.getElementById('maze-tech-view');
            mazeView.innerHTML = '';
            
            // Render full maze with walls and mines
            for (let y = 0; y < 7; y++) {
                for (let x = 0; x < 7; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'maze-cell';
                    
                    const type = state.mazeLayout[y][x];
                    if (type === 1) {
                        cell.classList.add('wall');
                    } else if (type === 2) {
                        cell.classList.add('mine');
                    } else if (type === 3) {
                        cell.classList.add('exit');
                    } else {
                        cell.classList.add('bg-gray-700');
                    }
                    
                    mazeView.appendChild(cell);
                }
            }
        }
        
        function handlePlayerMove(data) {
            // Update technician's position display
            document.getElementById('tech-pos-display').textContent = `(${data.pos.x}, ${data.pos.y})`;
        }
        
        function handleMazeResult(data) {
            if (data.result === 'wall') {
                AudioEngine.playError();
                showAlert('¬°PARED!', 'El operador choc√≥');
            } else if (data.result === 'mine') {
                AudioEngine.playError();
                showAlert('üí• ¬°MINA!', 'El operador pis√≥ una mina');
            }
        }
        
        function completeLevel4() {
            sendMessage('game-complete');
            showFinalSuccess();
        }
        
        // ============================================
        // FINAL SUCCESS
        // ============================================
        function showFinalSuccess() {
            AudioEngine.stopAmbient();
            
            // First, show door closing animation
            showDoorAnimation(() => {
                // After doors close, show victory screen
                showVictoryScreen();
            });
        }
        
        function showDoorAnimation(callback) {
            const doorAnimation = document.getElementById('door-animation');
            const doorLeft = document.getElementById('door-left');
            const doorRight = document.getElementById('door-right');
            
            doorAnimation.classList.remove('hidden');
            
            // Play door closing sound
            if (AudioEngine.ctx && AudioEngine.enabled) {
                AudioEngine.resume();
                const osc = AudioEngine.ctx.createOscillator();
                const gain = AudioEngine.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(80, AudioEngine.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(40, AudioEngine.ctx.currentTime + 1);
                gain.gain.setValueAtTime(0.2, AudioEngine.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.4, AudioEngine.ctx.currentTime + 0.5);
                gain.gain.linearRampToValueAtTime(0.1, AudioEngine.ctx.currentTime + 1);
                osc.connect(gain);
                gain.connect(AudioEngine.ctx.destination);
                osc.start();
                osc.stop(AudioEngine.ctx.currentTime + 1);
            }
            
            // Trigger door close animation
            setTimeout(() => {
                doorLeft.classList.add('door-close-left');
                doorRight.classList.add('door-close-right');
            }, 100);
            
            // After doors close, execute callback
            setTimeout(() => {
                if (navigator.vibrate) navigator.vibrate(200);
                callback();
            }, 1200);
        }
        
        function showVictoryScreen() {
            playerAScreen.classList.add('hidden');
            playerBScreen.classList.add('hidden');
            document.getElementById('door-animation').classList.add('hidden');
            
            const victoryScreen = document.getElementById('victory-screen');
            victoryScreen.classList.remove('hidden');
            
            // Calculate time
            let elapsed = 0;
            if (state.startTime) {
                elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                document.getElementById('victory-time').textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            // Show errors
            document.getElementById('victory-errors').textContent = state.totalErrors;
            
            // Calculate efficiency (based on errors and time)
            // Base efficiency of 100%, lose 5% per error, lose 1% per 30 seconds over 3 minutes
            let efficiency = 100;
            efficiency -= state.totalErrors * 5;
            if (elapsed > 180) {
                efficiency -= Math.floor((elapsed - 180) / 30);
            }
            efficiency = Math.max(0, Math.min(100, efficiency));
            document.getElementById('victory-efficiency').textContent = `${efficiency}%`;
            
            // Calculate rank
            let rank, rankDesc, stars;
            if (state.totalErrors === 0 && elapsed < 180) {
                rank = "ELITE S+";
                rankDesc = "¬°Perfecci√≥n absoluta! Trabajo de √©lite.";
                stars = 5;
            } else if (state.totalErrors === 0) {
                rank = "ELITE S";
                rankDesc = "Sin errores. Equipo excepcional.";
                stars = 5;
            } else if (state.totalErrors <= 2 && elapsed < 240) {
                rank = "ESPECIALISTA A";
                rankDesc = "Coordinaci√≥n impecable bajo presi√≥n.";
                stars = 4;
            } else if (state.totalErrors <= 4) {
                rank = "VETERANO B";
                rankDesc = "Buen trabajo en equipo, pocas fallas.";
                stars = 3;
            } else if (state.totalErrors <= 7) {
                rank = "SOBREVIVIENTE C";
                rankDesc = "Lo lograron, pero con dificultades.";
                stars = 2;
            } else if (state.totalErrors <= 12) {
                rank = "NOVATO D";
                rankDesc = "Escaparon por poco. Necesitan pr√°ctica.";
                stars = 1;
            } else {
                rank = "APRENDIZ F";
                rankDesc = "Muchos errores, pero lo lograron.";
                stars = 1;
            }
            
            // Animate stats appearing one by one
            setTimeout(() => {
                // Show efficiency with color coding
                const effEl = document.getElementById('victory-efficiency');
                if (efficiency >= 80) effEl.className = 'text-green-400 font-bold';
                else if (efficiency >= 60) effEl.className = 'text-yellow-400 font-bold';
                else if (efficiency >= 40) effEl.className = 'text-orange-400 font-bold';
                else effEl.className = 'text-red-400 font-bold';
            }, 500);
            
            // Animate rank with typing effect
            setTimeout(() => {
                const rankEl = document.getElementById('victory-rank');
                rankEl.classList.add('rank-reveal');
                typeEffect(rankEl, rank, () => {
                    // After rank is typed, show description
                    setTimeout(() => {
                        const descEl = document.getElementById('rank-desc-text');
                        typeEffect(descEl, rankDesc);
                    }, 300);
                });
            }, 1000);
            
            // Animate star rating
            setTimeout(() => {
                const starContainer = document.getElementById('star-rating');
                starContainer.innerHTML = '';
                
                for (let i = 0; i < 5; i++) {
                    const star = document.createElement('span');
                    star.className = 'text-3xl star-animate';
                    star.style.animationDelay = `${i * 0.15}s`;
                    
                    if (i < stars) {
                        star.textContent = '‚≠ê';
                    } else {
                        star.textContent = '‚òÜ';
                        star.classList.add('text-gray-600');
                    }
                    
                    starContainer.appendChild(star);
                }
            }, 1500);
            
            // Play victory sound
            setTimeout(() => {
                AudioEngine.playSuccess();
            }, 500);
        }
        
        // Typing effect function
        function typeEffect(element, text, callback) {
            let i = 0;
            element.textContent = "";
            element.classList.add('typing-cursor');
            
            const interval = setInterval(() => {
                element.textContent += text[i];
                i++;
                
                // Play subtle tick sound
                if (AudioEngine.ctx && AudioEngine.enabled && i % 2 === 0) {
                    AudioEngine.resume();
                    const osc = AudioEngine.ctx.createOscillator();
                    const gain = AudioEngine.ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = 800 + Math.random() * 200;
                    gain.gain.setValueAtTime(0.05, AudioEngine.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, AudioEngine.ctx.currentTime + 0.05);
                    osc.connect(gain);
                    gain.connect(AudioEngine.ctx.destination);
                    osc.start();
                    osc.stop(AudioEngine.ctx.currentTime + 0.05);
                }
                
                if (i >= text.length) {
                    clearInterval(interval);
                    element.classList.remove('typing-cursor');
                    if (callback) callback();
                }
            }, 80);
        }
        
        // Legacy function for compatibility
        function showFinalSuccessLegacy() {
            AudioEngine.stopAmbient();
            playerAScreen.classList.add('hidden');
            playerBScreen.classList.add('hidden');
            successScreen.classList.remove('hidden');
            
            document.getElementById('final-errors').textContent = state.totalErrors;
            
            if (state.startTime) {
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                document.getElementById('final-time').textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            AudioEngine.playSuccess();
        }
        
        // ============================================
        // FULLSCREEN
        // ============================================
        document.getElementById('fullscreen-btn').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen?.() || 
                document.documentElement.webkitRequestFullscreen?.();
                document.getElementById('fullscreen-btn').textContent = '‚úï';
            } else {
                document.exitFullscreen?.() || document.webkitExitFullscreen?.();
                document.getElementById('fullscreen-btn').textContent = '‚õ∂';
            }
        });
        
        // Initialize
        init();
    </script>
</body>

</html>

